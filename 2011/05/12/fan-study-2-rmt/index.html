<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script type="text/javascript">
    var CoCat = {
      isHome: false,
      isPost: true,
      isArchive: false
    };
  </script>
  
  <title>单片机控制笔记本风扇(2)-串口控制与测速 | CatX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="第二部分完成。
A.速度控制

首先增加电路方便调试：
两个按钮连接到两个中断口INT0/P3.2和IN1/P3.3，一个加速一个减速。
两个LED连接到P0.1和P0.3，显示速度是否为0或者是否最大。
一个开关接到风扇和Vcc之间，出错的话可以快速杀掉风扇。">
<meta property="og:type" content="article">
<meta property="og:title" content="单片机控制笔记本风扇(2)-串口控制与测速">
<meta property="og:url" content="http://catx.me/2011/05/12/fan-study-2-rmt/index.html">
<meta property="og:site_name" content="CatX">
<meta property="og:description" content="第二部分完成。
A.速度控制

首先增加电路方便调试：
两个按钮连接到两个中断口INT0/P3.2和IN1/P3.3，一个加速一个减速。
两个LED连接到P0.1和P0.3，显示速度是否为0或者是否最大。
一个开关接到风扇和Vcc之间，出错的话可以快速杀掉风扇。">
<meta property="og:image" content="http://catx.me/images/3007bf5075c98f7c0d519298341a6ea976d57243.jpg">
<meta property="og:updated_time" content="2015-05-05T21:42:57.554Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="单片机控制笔记本风扇(2)-串口控制与测速">
<meta name="twitter:description" content="第二部分完成。
A.速度控制

首先增加电路方便调试：
两个按钮连接到两个中断口INT0/P3.2和IN1/P3.3，一个加速一个减速。
两个LED连接到P0.1和P0.3，显示速度是否为0或者是否最大。
一个开关接到风扇和Vcc之间，出错的话可以快速杀掉风扇。">
  <!-- Swiftype -->
  <meta class="swiftype" name="title" data-type="string" content="单片机控制笔记本风扇(2)-串口控制与测速">

  
    <link rel="alternative" href="/atom.xml" title="CatX" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
</head>

<body>
  <div id="app"><div class="master is-post" data-reactid=".24lhhqx8tfk" data-react-checksum="-156090447"><div class="top-banner" style="display:none;" data-reactid=".24lhhqx8tfk.0"><span data-reactid=".24lhhqx8tfk.0.0">Banner Message</span><a href="#" data-reactid=".24lhhqx8tfk.0.1">Go</a></div><nav class="navbar navbar-inverse" style="text-shadow:0px 0px 10px rgba(0, 0, 0, 0.1), 0px 0px 5px rgba(0, 0, 0, 0.1), 0px 0px 10px #947444, 0px 0px 5px #947444;" data-reactid=".24lhhqx8tfk.1"><div class="container" data-reactid=".24lhhqx8tfk.1.0"><div class="navbar-header" data-reactid=".24lhhqx8tfk.1.0.0"><a class="navbar-link hamburger-menu icon-link" href="javascript:void(0)" data-reactid=".24lhhqx8tfk.1.0.0.0"><i class="fa fa-2x fa-bars" data-reactid=".24lhhqx8tfk.1.0.0.0.0"></i></a><a class="navbar-brand" href="#" data-reactid=".24lhhqx8tfk.1.0.0.1"><i class="logo icon cocat-logo" data-reactid=".24lhhqx8tfk.1.0.0.1.0"></i><span data-reactid=".24lhhqx8tfk.1.0.0.1.1">CatX</span></a><span data-reactid=".24lhhqx8tfk.1.0.0.2"></span></div><div class="collapse navbar-collapse" data-reactid=".24lhhqx8tfk.1.0.1"><form class="navbar-form navbar-right" role="search" data-reactid=".24lhhqx8tfk.1.0.1.0"><div class="form-group" data-reactid=".24lhhqx8tfk.1.0.1.0.0"><input type="text" class="form-control" placeholder="Search" data-reactid=".24lhhqx8tfk.1.0.1.0.0.0"/></div></form><ul class="nav navbar-nav navbar-right" data-reactid=".24lhhqx8tfk.1.0.1.1"><li class="" data-reactid=".24lhhqx8tfk.1.0.1.1.$Home"><a class="" href="/" data-reactid=".24lhhqx8tfk.1.0.1.1.$Home.0">Home</a></li><li class="" data-reactid=".24lhhqx8tfk.1.0.1.1.$Archives"><a class="" href="/archives/" data-reactid=".24lhhqx8tfk.1.0.1.1.$Archives.0">Archives</a></li></ul></div></div></nav><div class="post-wrapper" data-reactid=".24lhhqx8tfk.2"><section id="preview" style="background-color:#947444;" class="dark" data-reactid=".24lhhqx8tfk.2.0"><div class="intro-wrapper" data-reactid=".24lhhqx8tfk.2.0.0"><div class="container" data-reactid=".24lhhqx8tfk.2.0.0.0"><div class="row" data-reactid=".24lhhqx8tfk.2.0.0.0.0"><div class="feature-image col-sm-8 col-sm-push-4 col-xs-12" data-reactid=".24lhhqx8tfk.2.0.0.0.0.0"><img alt="Feature image" src="/image/stock/4.jpg" data-reactid=".24lhhqx8tfk.2.0.0.0.0.0.0"/></div><div style="text-shadow:0px 0px 10px rgba(0, 0, 0, 0.1), 0px 0px 5px rgba(0, 0, 0, 0.1), 0px 0px 10px #947444, 0px 0px 5px #947444;" class="post-title col-sm-4 col-sm-pull-8 col-xs-12 col-xs-12" data-reactid=".24lhhqx8tfk.2.0.0.0.0.1"><h1 data-reactid=".24lhhqx8tfk.2.0.0.0.0.1.0">单片机控制笔记本风扇(2)-串口控制与测速</h1><div class="post-intro" data-reactid=".24lhhqx8tfk.2.0.0.0.0.1.1"><p>第二部分完成。</p>
<p><strong>A.速度控制
</strong></p>
<p>首先增加电路方便调试：</p>
<p>两个按钮连接到两个中断口INT0/P3.2和IN1/P3.3，一个加速一个减速。</p>
<p>两个LED连接到P0.1和P0.3，显示速度是否为0或者是否最大。</p>
<p>一个开关接到风扇和Vcc之间，出错的话可以快速杀掉风扇。</p></div></div></div></div></div></section><section id="post-action" data-reactid=".24lhhqx8tfk.2.1"><div class="container" data-reactid=".24lhhqx8tfk.2.1.0"><div class="post-socials" data-reactid=".24lhhqx8tfk.2.1.0.0"><div class="like-button" data-reactid=".24lhhqx8tfk.2.1.0.0.0"><a class="social icon-link" href="javascript:void(0);" data-reactid=".24lhhqx8tfk.2.1.0.0.0.0"><i class="fa fa-2 fa-heart-o" data-reactid=".24lhhqx8tfk.2.1.0.0.0.0.0"></i></a></div><span data-reactid=".24lhhqx8tfk.2.1.0.0.1">TODO: duoshuo</span></div><div class="action-buttons" data-reactid=".24lhhqx8tfk.2.1.0.1">TODO: action buttons</div></div></section><article data-reactid=".24lhhqx8tfk.2.2"><div class="container" data-reactid=".24lhhqx8tfk.2.2.0"><p>第二部分完成。</p>
<p><strong>A.速度控制
</strong></p>
<p>首先增加电路方便调试：</p>
<p>两个按钮连接到两个中断口INT0/P3.2和IN1/P3.3，一个加速一个减速。</p>
<p>两个LED连接到P0.1和P0.3，显示速度是否为0或者是否最大。</p>
<p>一个开关接到风扇和Vcc之间，出错的话可以快速杀掉风扇。</p>
<a id="more"></a>
<p>剩的就是代码了，PWM部分：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化PWM0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PWM_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	CCON = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	CMOD = <span class="number">0x02</span>;</span><br><span class="line"></span><br><span class="line">	CL = <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line">	CH = <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line">	CCAPM0 = <span class="number">0x42</span>;</span><br><span class="line"></span><br><span class="line">	CCAP0L = <span class="number">0x80</span>;</span><br><span class="line"></span><br><span class="line">	CCAP0H = <span class="number">0x80</span>;</span><br><span class="line"></span><br><span class="line">	CR = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置PWM0占空比实现速度控制</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PWM0_set</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> a)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	CCAP0L = a;</span><br><span class="line"></span><br><span class="line">	CCAP0H = a;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//四个控速函数SPEED_UP(), SPEED_DOWN, SPEED_FULL, SPEED_STOP中调用PWM0_set，检查边界，处理LED，以UP为例</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">SPEED_UP</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (PWM_VALUE &amp;gt; <span class="number">0x00</span>) &#123;</span><br><span class="line"></span><br><span class="line">		PWM_VALUE --;</span><br><span class="line"></span><br><span class="line">		PWM0_set(PWM_VALUE);</span><br><span class="line"></span><br><span class="line">		LED_L = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		LED_R = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">		LED_R = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0x02</span>; <span class="comment">//Top speed 0010,用于串口通信</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">两个按钮的中断响应函数</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Left button</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">INT_1</span><span class="params">(<span class="keyword">void</span>)</span> interrupt 2 <span class="keyword">using</span> 2 </span>&#123;</span><br><span class="line"></span><br><span class="line">		SPEED_DOWN();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Right button</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">INT_0</span><span class="params">(<span class="keyword">void</span>)</span> interrupt 0 <span class="keyword">using</span> 1 </span>&#123;</span><br><span class="line"></span><br><span class="line">	SPEED_UP();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>B.串口通信
</strong></p>
<p>1.通信协议：</p>
<p>波特率4800bps，停止位1。</p>
<p>2.控制帧：</p>
<table>
<thead>
<tr>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
</tr>
</thead>
<tbody>
<tr>
<td>HEAD(0xFE)</td>
<td>CTRL(1 byte)</td>
<td>PWM_VALUE(1 byte)</td>
<td>END(0xFF)</td>
</tr>
</tbody>
</table>
<p>由电脑发出实现控制。</p>
<p>CTRL取值 a,s,w,d的ascii码，分别代表停止、减速、加速、全速，虽然其实只需要占用2位就能完成编码，主要是为了兼容一开始时用终端人肉调试时的习惯懒得修改。</p>
<p>计划增加一个x控制码，可以直接将PWM占空比设定到第三位的PWM_VALUE。</p>
<p>3.数据帧：</p>
<p>单片机向电脑发送的数据，有两种类型。</p>
<p>a.响应帧：</p>
<p>每收到一个控制帧，就会传回一个响应帧，如果需要，可附加执行结果。</p>
<table>
<thead>
<tr>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
</tr>
</thead>
<tbody>
<tr>
<td>TAG(0xF1)</td>
<td>CTRL(1 byte)</td>
<td>EXTRA_DATA(1 byte)</td>
<td>END(0xFF)</td>
</tr>
</tbody>
</table>
<p>TAG用于帧类型识别。</p>
<p>CTRL与收到的控制帧相同。</p>
<p>EXTRA_DATA为附加数据，目前只用到最后两位编码风扇是否达到最大或最小速度（0x02和0x01），便于电脑上客户端软件正确刷新UI。</p>
<p>b.信息帧：</p>
<p>每秒发送一帧，包含风扇转速。</p>
<table>
<thead>
<tr>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
</tr>
</thead>
<tbody>
<tr>
<td>TAG(0xF0)</td>
<td>SPEED (1 byte)</td>
<td>SPEED(1 byte)</td>
<td>END(0xFF)</td>
</tr>
</tbody>
</table>
<p>TAG用于帧类型识别。</p>
<p>SPEED从高位到低位存储。</p>
<p>4.代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//串口初始化</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UART_init</span> <span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//EA = 1; //允许总中断</span></span><br><span class="line"></span><br><span class="line">	ES = <span class="number">1</span>; <span class="comment">//允许UART串口的中断</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//TMOD = 0x20;    //定时器T/C1工作方式2</span></span><br><span class="line"></span><br><span class="line">	SCON = <span class="number">0x50</span>;    <span class="comment">//串口工作方式1，允许串口接收（SCON = 0x40 时禁止串口接收）</span></span><br><span class="line"></span><br><span class="line">	TH1 = <span class="number">0xF3</span>;    <span class="comment">//定时器初值高8位设置</span></span><br><span class="line"></span><br><span class="line">	TL1 = <span class="number">0xF3</span>;    <span class="comment">//定时器初值低8位设置</span></span><br><span class="line"></span><br><span class="line">	PCON = <span class="number">0x80</span>;    <span class="comment">//波特率倍频（注销本句波特率为2400）</span></span><br><span class="line"></span><br><span class="line">	TR1 = <span class="number">1</span>;    <span class="comment">//定时器启动</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送一个byte数据</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UART_T</span> <span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> UART_data)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	SBUF = UART_data;    <span class="comment">//将接收的数据发送回去</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(TI == <span class="number">0</span>);        <span class="comment">//检查发送中断标志位</span></span><br><span class="line"></span><br><span class="line">	TI = <span class="number">0</span>;            <span class="comment">//令发送中断标志位为0</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//中断响应数据</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UART_R</span> <span class="params">(<span class="keyword">void</span>)</span> interrupt 4 <span class="keyword">using</span> 1</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> UART_data; <span class="comment">//定义串口接收数据变量</span></span><br><span class="line"></span><br><span class="line">	RI = <span class="number">0</span>;            <span class="comment">//令接收中断标志位为0（软件清零）</span></span><br><span class="line"></span><br><span class="line">	UART_T(<span class="number">0xF1</span>); <span class="comment">//Response</span></span><br><span class="line"></span><br><span class="line">	UART_data = SBUF;    <span class="comment">//将接收到的数据送入变量 UART_data</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//用户函数内容（用户可使用UART_data做数据处理）</span></span><br><span class="line"></span><br><span class="line">	UART_T(UART_data);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (UART_data) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> <span class="string">'a'</span>:</span><br><span class="line"></span><br><span class="line">		UART_T(SPEED_STOP());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> <span class="string">'d'</span>:</span><br><span class="line"></span><br><span class="line">		UART_T(SPEED_FULL());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> <span class="string">'w'</span>:</span><br><span class="line"></span><br><span class="line">		UART_T(SPEED_UP());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> <span class="string">'s'</span>:</span><br><span class="line"></span><br><span class="line">		UART_T(SPEED_DOWN());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	UART_T(<span class="number">0xFF</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>C.测速
</strong></p>
<p>风扇每转一圈输出2个脉冲，所以只要计算采样时间内脉冲数量就可以测速。要达到这个目的，需要一个计数器记录脉冲数量，一个定时器在固定的时间生成数据帧通过串口发送，然后清零计数器</p>
<p>STC12C5A60S2有两个计时器/计数器T0和T1，T1已经被串口通信占用，所以只能使用T0作为计数器，将风扇黄色引脚连T0/P3.4</p>
<p>还需要一个计时器，通过数据手册发现两个PWM口都可以被设置为定时器使用，于是用没有被占用的PWM1进行计时。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计数器初始化</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">T_C_init</span> <span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//TMOD = 0x11; //高4位控制T/C1 [ GATE，C/T，M1，M0，GATE，C/T，M1，M0 ]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//EA = 1;    //中断总开关</span></span><br><span class="line"></span><br><span class="line">	TH0 = <span class="number">0x00</span>; <span class="comment">//16位计数寄存器T0高8位</span></span><br><span class="line"></span><br><span class="line">	TL0 = <span class="number">0x00</span>; <span class="comment">//16位计数寄存器T0低8位s</span></span><br><span class="line"></span><br><span class="line">	ET0 = <span class="number">1</span>; <span class="comment">//T/C0中断开关</span></span><br><span class="line"></span><br><span class="line">	TR0 = <span class="number">1</span>; <span class="comment">//T/C0启动开关</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//计数器中断响应</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">T_C0</span> <span class="params">(<span class="keyword">void</span>)</span> interrupt 1 <span class="keyword">using</span> 1</span>&#123;</span><br><span class="line"></span><br><span class="line">	TH0 = <span class="number">0x00</span>; <span class="comment">//重置计数器</span></span><br><span class="line"></span><br><span class="line">	TL0 = <span class="number">0x00</span>; <span class="comment">//以风扇的转速，这段代码被执行的概率非常低</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//PWM1计时器模式</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PCA_TIMER1_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	CCON = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	CL = <span class="number">0</span>; <span class="comment">//Reset PCA base time;</span></span><br><span class="line"></span><br><span class="line">	CH = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	CMOD = <span class="number">0x00</span>;    <span class="comment">//Timer clock source as Fosc/12</span></span><br><span class="line"></span><br><span class="line">	value = T100Hz;</span><br><span class="line"></span><br><span class="line">	CCAP1L = value;</span><br><span class="line"></span><br><span class="line">	CCAP1H = value &amp;gt;&amp;gt; <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">	value += T100Hz;</span><br><span class="line"></span><br><span class="line">	CCAPM1 = <span class="number">0x49</span>;    <span class="comment">//PCA 0 in 16bit timer mode and enable PCA interuppt</span></span><br><span class="line"></span><br><span class="line">	CR = <span class="number">1</span>;    <span class="comment">//PCA timer start</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//PWM1计时器中断，执行频率为100Hz，每1秒发送一个数据包</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PCA_TIMER1</span><span class="params">()</span> interrupt 7 <span class="keyword">using</span> 1 </span>&#123;</span><br><span class="line"></span><br><span class="line">	CCF1 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	CCAP1L = value;</span><br><span class="line"></span><br><span class="line">	CCAP1H = value &amp;gt;&amp;gt; <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">	value += T100Hz;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cnt == <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		UART_T(<span class="number">0xF0</span>); <span class="comment">//Info</span></span><br><span class="line"></span><br><span class="line">		UART_T(TH0);</span><br><span class="line"></span><br><span class="line">		UART_T(TL0);</span><br><span class="line"></span><br><span class="line">		UART_T(<span class="number">0xFF</span>);</span><br><span class="line"></span><br><span class="line">		TH0 = <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line">		TL0 = <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line">		cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">		cnt++;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后得事情就很简单了，用C#写了一个Windows Form Application来获取转速并实现控制：</p>
<p><img src="/images/3007bf5075c98f7c0d519298341a6ea976d57243.jpg" alt=""></p>
<p>最高转速为50RPS左右，约3000RPM，和在上一篇通过比特率估计的数量级一致。</p>
<p>很有意思的一个发现是，风扇口被堵住时，转速会升高。</p>
</div></article></div><footer class="footer" data-reactid=".24lhhqx8tfk.3"><div class="container" data-reactid=".24lhhqx8tfk.3.0"><div class="row" data-reactid=".24lhhqx8tfk.3.0.0"><div class="col-md-6 footer-left" data-reactid=".24lhhqx8tfk.3.0.0.0"><p data-reactid=".24lhhqx8tfk.3.0.0.0.0"><span data-reactid=".24lhhqx8tfk.3.0.0.0.0.0"><span data-reactid=".24lhhqx8tfk.3.0.0.0.0.0.0">© 2015 </span><span data-reactid=".24lhhqx8tfk.3.0.0.0.0.0.1">CatX</span><span data-reactid=".24lhhqx8tfk.3.0.0.0.0.0.2"> by </span><a href="#" data-reactid=".24lhhqx8tfk.3.0.0.0.0.0.3">AKFish</a><span data-reactid=".24lhhqx8tfk.3.0.0.0.0.0.4">. </span></span><span data-reactid=".24lhhqx8tfk.3.0.0.0.0.1"><a href="https://github.com/akfish/hexo-cocat-theme" data-reactid=".24lhhqx8tfk.3.0.0.0.0.1.0">CoCat</a><span data-reactid=".24lhhqx8tfk.3.0.0.0.0.1.1"> Theme by </span><a href="http://catx.me" data-reactid=".24lhhqx8tfk.3.0.0.0.0.1.2">AKFish</a></span></p><ul data-reactid=".24lhhqx8tfk.3.0.0.0.1"><li data-reactid=".24lhhqx8tfk.3.0.0.0.1.$admin@example=1com"><a href="mailto:admin@example.com" target="_blank" data-reactid=".24lhhqx8tfk.3.0.0.0.1.$admin@example=1com.0">admin@example.com</a></li><li data-reactid=".24lhhqx8tfk.3.0.0.0.1.$About"><a href="/about.html" target="_blank" data-reactid=".24lhhqx8tfk.3.0.0.0.1.$About.0">About</a></li><li data-reactid=".24lhhqx8tfk.3.0.0.0.1.$Terms"><a href="/terms.html" target="_blank" data-reactid=".24lhhqx8tfk.3.0.0.0.1.$Terms.0">Terms</a></li><li data-reactid=".24lhhqx8tfk.3.0.0.0.1.$FAQ"><a href="/faq.html" target="_blank" data-reactid=".24lhhqx8tfk.3.0.0.0.1.$FAQ.0">FAQ</a></li></ul></div><div class="col-md-6 footer-socials" data-reactid=".24lhhqx8tfk.3.0.0.1"><a style="background:transparent;" class="social icon-link github" href="https://github.com/user" target="_blank" data-reactid=".24lhhqx8tfk.3.0.0.1.$github"><i class="fa fa-2 fa-github" data-reactid=".24lhhqx8tfk.3.0.0.1.$github.0"></i></a><a style="background:transparent;" class="social icon-link twitter" href="https://twitter.com/user" target="_blank" data-reactid=".24lhhqx8tfk.3.0.0.1.$twitter"><i class="fa fa-2 fa-twitter" data-reactid=".24lhhqx8tfk.3.0.0.1.$twitter.0"></i></a><a style="background:transparent;" class="social icon-link facebook" href="https://facebook.com/user" target="_blank" data-reactid=".24lhhqx8tfk.3.0.0.1.$facebook"><i class="fa fa-2 fa-facebook" data-reactid=".24lhhqx8tfk.3.0.0.1.$facebook.0"></i></a><a style="background:transparent;" class="social icon-link google" href="https://plus.google.com/user" target="_blank" data-reactid=".24lhhqx8tfk.3.0.0.1.$google"><i class="fa fa-2 fa-google-plus-square" data-reactid=".24lhhqx8tfk.3.0.0.1.$google.0"></i></a><a style="background:transparent;" class="social icon-link dribbble" href="https://dribbble.com/user" target="_blank" data-reactid=".24lhhqx8tfk.3.0.0.1.$dribbble"><i class="fa fa-2 fa-dribbble" data-reactid=".24lhhqx8tfk.3.0.0.1.$dribbble.0"></i></a><a style="background:transparent;" class="social icon-link rss" href="/atom.xml" target="_blank" data-reactid=".24lhhqx8tfk.3.0.0.1.$rss"><i class="fa fa-2 fa-rss" data-reactid=".24lhhqx8tfk.3.0.0.1.$rss.0"></i></a></div></div></div></footer></div></div>

  <script src="/script/cocat.js" type="text/javascript"></script>
  <script type="text/javascript" src="/react_bundle.js"></script>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>
