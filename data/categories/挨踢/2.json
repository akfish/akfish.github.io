{"category":"挨踢","isDark":false,"type":"category","path":"categories/挨踢/page/2/","json_base":"data/categories/挨踢/","json":"data/categories/挨踢/2.json","prev":"data/categories/挨踢/1.json","next":"data/categories/挨踢/3.json","current":2,"total":3,"posts":[{"type":"post","json_base":"data/posts","json":"data/posts/2014/03/12/hexo-uml-tag-plugin.json","path":"2014/03/12/hexo-uml-tag-plugin/","data":{"title":"Hexo UML插件","content":"<h2 id=\"u4ECB_u7ECD\"><a href=\"#u4ECB_u7ECD\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p>技术类博客总是不可避免的要插入各种UML图，昨天偶然发现一个有意思的Javascript库<a href=\"http://jumly.tmtk.net/\" target=\"_blank\" rel=\"external\">Jumly</a>，用于渲染UML sequence diagram和robustness diagram。于是制作了一个hexo插件，便于在博客中插入。</p>\n<p><strong>Sequence Diagram</strong><br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@found &#34;You&#34;, -&#62;&#10;  @message &#34;Think&#34;, -&#62;&#10;    @message &#34;Write your idea&#34;, &#34;hexo-tag-uml&#34;, -&#62;&#10;      @message &#34;&#34;, &#34;JUMLY&#34;, -&#62;&#10;        @create &#34;Diagram&#34;&#10;hexo_tag_uml.css &#34;background-color&#34;:&#34;#8CC84B&#34;</span><br></pre></td></tr></table></figure></p>\n<p><strong>Robustness Diagram</strong><br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@actor &#34;User&#34; :-&#62; @view &#34;Browser&#34;&#10;@view &#34;Browser&#34; :-&#62; @controller &#34;Server&#34;&#10;@controller &#34;Server&#34; :-&#62; @entity &#34;Database&#34;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"u5B89_u88C5\"><a href=\"#u5B89_u88C5\" class=\"headerlink\" title=\"安装\"></a>安装</h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ npm install hexo-tag-uml --save</span><br></pre></td></tr></table></figure>\n<h2 id=\"u521D_u59CB_u5316\"><a href=\"#u521D_u59CB_u5316\" class=\"headerlink\" title=\"初始化\"></a>初始化</h2><p>在blog文件夹中执行：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo uml install</span><br></pre></td></tr></table></figure>\n<p>在<code>_config.yml</code>文件中添加：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plugins:&#10;- hexo-tag-uml</span><br></pre></td></tr></table></figure></p>\n<p>在主题的<code>.ejs</code>文件的合适位置插入：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"title\">%-</span> <span class=\"attribute\">partial</span>('<span class=\"attribute\">jumly</span>') %&gt;</span></span><br></pre></td></tr></table></figure>\n<p>一般而言可以放在<code>&lt;head&gt;</code>一节里，需要注意的是Jumly依赖于jQuery，如果主题里引用了其它位置的jQuery，会导致冲突。<br>比如hexo的默认主题landscape就在<code>after-footer.ejs</code>中插入了jQuery，需要将相应行去掉，替换为上面语句。<br>也是因为实际主题的实现哥又不同，这个插件没能实现自动修改theme layout文件。</p>\n<h2 id=\"u8BED_u6CD5\"><a href=\"#u8BED_u6CD5\" class=\"headerlink\" title=\"语法\"></a>语法</h2><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&amp;#37; uml [diagram_type] %&#125;</span><br><span class=\"line\">&#123;&amp;#37; uml %&#125;</span><br></pre></td></tr></table></figure>\n<p><code>diagram_type</code>可以取的值为：</p>\n<ul>\n<li>sequence</li>\n<li>robustness</li>\n</ul>\n<p>如果留空，默认为sequence。</p>\n<h2 id=\"u793A_u4F8B\"><a href=\"#u793A_u4F8B\" class=\"headerlink\" title=\"示例\"></a>示例</h2><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&amp;#37; uml %&#125;</span><br><span class=\"line\">@found \"Browser\", -&gt;</span><br><span class=\"line\">  @alt &#123;</span><br><span class=\"line\"><span class=\"code\">    \"[200]\": -&gt; @message \"GET href resources\", \"HTTP Server\"</span></span><br><span class=\"line\"><span class=\"code\">    \"[301]\": -&gt; @ref \"GET the moved page\"</span></span><br><span class=\"line\"><span class=\"code\">    \"[404]\": -&gt; @ref \"show NOT FOUND\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">@find(\".ref\").css(width:256, \"padding-bottom\":4)</span><br><span class=\"line\">  .find(\".tag\").css float:\"left\"</span><br><span class=\"line\">get<span class=\"emphasis\">_the_</span>moved_page.css \"background-color\":\"#80c080\"</span><br><span class=\"line\">show<span class=\"emphasis\">_not_</span>found.css \"background-color\":\"#f0b0b0\"</span><br><span class=\"line\">&#123;&amp;#37; enduml %&#125;</span><br></pre></td></tr></table></figure>\n<p>效果</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@found &#34;Browser&#34;, -&#62;&#10;  @alt &#123;&#10;    &#34;[200]&#34;: -&#62; @message &#34;GET href resources&#34;, &#34;HTTP Server&#34;&#10;    &#34;[301]&#34;: -&#62; @ref &#34;GET the moved page&#34;&#10;    &#34;[404]&#34;: -&#62; @ref &#34;show NOT FOUND&#34;&#10;  &#125;&#10;@find(&#34;.ref&#34;).css(width:256, &#34;padding-bottom&#34;:4)&#10;  .find(&#34;.tag&#34;).css float:&#34;left&#34;&#10;get_the_moved_page.css &#34;background-color&#34;:&#34;#80c080&#34;&#10;show_not_found.css &#34;background-color&#34;:&#34;#f0b0b0&#34;</span><br></pre></td></tr></table></figure>\n<p>Jumly的表达式规则详见：<a href=\"http://jumly.tmtk.net/reference.html\" target=\"_blank\" rel=\"external\">Jumly Reference Manual</a></p>\n<p>在线编辑器：<a href=\"http://jumly.tmtk.net/try.html\" target=\"_blank\" rel=\"external\">Try Jumly</a></p>\n","date":"2014-03-12T06:23:37.000Z","path":"2014/03/12/hexo-uml-tag-plugin/","isDark":false,"featureColor":"#d19e40","featureImage":"/image/stock/5.jpg","excerpt":"","featureSwatch":{"Vibrant":{"color":"#d19e40","isDark":false,"contrast":2.433412395275077},"Muted":{"color":"#798249","isDark":true,"contrast":4.168289617634703},"DarkVibrant":{"color":"#97623d","isDark":true,"contrast":7.586487507499872},"DarkMuted":{"color":"#5a4e32","isDark":true,"contrast":14.22073373466042},"LightVibrant":{"color":"#d6c395","isDark":false,"contrast":1.7356438765314866},"LightMuted":{"color":"#aea18e","isDark":false,"contrast":2.5336980009663206}},"permalink":"http://catx.me/2014/03/12/hexo-uml-tag-plugin/","json":"data/posts/2014/03/12/hexo-uml-tag-plugin.json","tags":[{"name":"CoffeeScript","slug":"CoffeeScript","path":"tags/CoffeeScript/","permalink":"http://catx.me/tags/CoffeeScript/","postCount":6},{"name":"GitHub","slug":"GitHub","path":"tags/GitHub/","permalink":"http://catx.me/tags/GitHub/","postCount":6},{"name":"Hexo","slug":"Hexo","path":"tags/Hexo/","permalink":"http://catx.me/tags/Hexo/","postCount":3},{"name":"Jumly","slug":"Jumly","path":"tags/Jumly/","permalink":"http://catx.me/tags/Jumly/","postCount":1},{"name":"Node.Js","slug":"Node-Js","path":"tags/Node-Js/","permalink":"http://catx.me/tags/Node-Js/","postCount":3},{"name":"UML","slug":"UML","path":"tags/UML/","permalink":"http://catx.me/tags/UML/","postCount":1}],"categories":[{"name":"挨踢","slug":"挨踢","path":"categories/挨踢/","permalink":"http://catx.me/categories/挨踢/","postCount":17}]},"sha1":"cad5a159769f8b2a28978c2383bf0bbe1ed6d69b","isDigest":true},{"type":"post","json_base":"data/posts","json":"data/posts/2014/03/11/build-and-use-virtual-hid-driver.json","path":"2014/03/11/build-and-use-virtual-hid-driver/","data":{"title":"编译并使用虚拟HID驱动","content":"<h2 id=\"u80CC_u666F\"><a href=\"#u80CC_u666F\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>虚拟HID驱动用于虚拟一个或多个人机交互设备，如键盘、鼠标、摇杆等，作用都懂的。<br>经过搜索发现一个开源项目<a href=\"https://code.google.com/p/vmulti/\" target=\"_blank\" rel=\"external\">vmulti</a>，实现了虚拟的多点触控、鼠标、键盘、摇杆以及数位笔，省去了自己写驱动的麻烦。</p>\n<h2 id=\"u7F16_u8BD1vmulti\"><a href=\"#u7F16_u8BD1vmulti\" class=\"headerlink\" title=\"编译vmulti\"></a>编译vmulti</h2><ol>\n<li>安装WDK</li>\n<li>运行以管理员权限WDK build environment</li>\n<li>进入vmulti工程文件夹，运行</li>\n</ol>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">build -wgc</span><br></pre></td></tr></table></figure>\n<ol>\n<li>把编译生成的<code>vmulti.sys</code>、<code>multi.inf</code>、<code>hidkmdf.sys</code>文件放到同一个文件夹</li>\n<li>把WDK中的<code>WdfCoInstaller01009.dll</code>, <code>devcon.exe</code>也放到这个文件夹</li>\n</ol>\n<h2 id=\"u9A71_u52A8_u7B7E_u540D\"><a href=\"#u9A71_u52A8_u7B7E_u540D\" class=\"headerlink\" title=\"驱动签名\"></a>驱动签名</h2><p>Windows x64系统上无法安装无签名的驱动，需要进行self sign。所有操作需要在管理员权限的WDK build environment中执行。</p>\n<h3 id=\"u6253_u5F00Windows_u6D4B_u8BD5_u6A21_u5F0F\"><a href=\"#u6253_u5F00Windows_u6D4B_u8BD5_u6A21_u5F0F\" class=\"headerlink\" title=\"打开Windows测试模式\"></a>打开Windows测试模式</h3><p>要加载self sign的内核代码，需要打开windows的测试模式：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bcdedit /set testsigning on</span><br></pre></td></tr></table></figure>\n<p>重启。</p>\n<h3 id=\"u521B_u5EFA_u8BC1_u4E66\"><a href=\"#u521B_u5EFA_u8BC1_u4E66\" class=\"headerlink\" title=\"创建证书\"></a>创建证书</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">makecert -r -pe -ss &#34;CatX&#34; -n &#34;CN=CatX Test Certificate&#34; catx.cer&#10;certmgr -add catx.cer /s /r localMachine root&#10;certmgr -add catx.cer /s /r localMachine trustedpublisher</span><br></pre></td></tr></table></figure>\n<p>验证证书是否正确安装，运行：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certmgr</span><br></pre></td></tr></table></figure>\n<h3 id=\"u7B7E_u540D\"><a href=\"#u7B7E_u540D\" class=\"headerlink\" title=\"签名\"></a>签名</h3><p>驱动中的如下文件需要签名：</p>\n<ul>\n<li><code>*.sys</code>文件</li>\n<li><code>*.inf</code>中引用的<code>*.cat</code>文件</li>\n</ul>\n<p>如果<code>*.cat</code>文件不存在，需要运行inf2cat创建：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">inf2cat /driver:%driver_folder% /os:7_x64</span><br></pre></td></tr></table></figure>\n<p>vmulti需要签名的文件有vmulti.sys、hidkmdf.sys和kmdfsamples.cat，运行：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">signtool sign /v /s &#34;CatX&#34; /n &#34;CatX Test Certificate&#34; /t http://timestamp.verisign.com/scripts/timestamp.dll %file_name%</span><br></pre></td></tr></table></figure>\n<p>验证签名：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">signtool verify /pa /v *.cat *.sys</span><br></pre></td></tr></table></figure>\n<h2 id=\"u5B89_u88C5vmulti\"><a href=\"#u5B89_u88C5vmulti\" class=\"headerlink\" title=\"安装vmulti\"></a>安装vmulti</h2><p>运行：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">devcon install vmulti.inf djpnewton\\vmulti</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"u6D4B_u8BD5\"><a href=\"#u6D4B_u8BD5\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>vmulti工程中包含了一个测试程序<code>testvmulti.exe</code>，用于测试驱动功能：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">testvmulti.exe /multitouch&#10;testvmulti.exe /mouse&#10;testvmulti.exe /digitizer</span><br></pre></td></tr></table></figure></p>\n","date":"2014-03-11T02:24:16.000Z","path":"2014/03/11/build-and-use-virtual-hid-driver/","isDark":true,"featureColor":"#4e83a9","featureImage":"/images/cat-keyboard.jpg","excerpt":"","featureSwatch":{"Vibrant":{"color":"#4e83a9","isDark":true,"contrast":4.268205103945441},"Muted":{"color":"#66696d","isDark":true,"contrast":5.517007170923729},"DarkVibrant":{"color":"#5e4a2c","isDark":true,"contrast":14.365033884791707},"DarkMuted":{"color":"#484a69","isDark":true,"contrast":12.97746844631535},"LightVibrant":{"color":"#55bada","isDark":false,"contrast":2.2961725637158628},"LightMuted":{"color":"#e5e9da","isDark":false,"contrast":1.2353261496178072}},"permalink":"http://catx.me/2014/03/11/build-and-use-virtual-hid-driver/","json":"data/posts/2014/03/11/build-and-use-virtual-hid-driver.json","tags":[{"name":"HID","slug":"HID","path":"tags/HID/","permalink":"http://catx.me/tags/HID/","postCount":1},{"name":"驱动","slug":"驱动","path":"tags/驱动/","permalink":"http://catx.me/tags/驱动/","postCount":1}],"categories":[{"name":"挨踢","slug":"挨踢","path":"categories/挨踢/","permalink":"http://catx.me/categories/挨踢/","postCount":17}]},"sha1":"15d23f6704b4783e64e791b6ef72ad09d409d94d","isDigest":true},{"type":"post","json_base":"data/posts","json":"data/posts/2014/03/09/hexo-mathjax-plugin.json","path":"2014/03/09/hexo-mathjax-plugin/","data":{"title":"Hexo MathJax插件","content":"<div id=\"badge-container-akfish-hexo-math-6e264f5\" class=\"hexo-github\" style=\"width: 100%\"></div>\n<script src=\"/hexo-github/badge.js\"></script>\n<script type=\"text/javascript\">\n  loadStyle(\"/hexo-github/style.css\");\n  loadStyle(\"/hexo-github/octicons/octicons.css\");\n  new Badge(\"#badge-container-akfish-hexo-math-6e264f5\", \"akfish\", \"hexo-math\", \"6e264f5\", false);\n</script>\n\n<h2 id=\"u4ECB_u7ECD\"><a href=\"#u4ECB_u7ECD\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p>Hexo不支持数学公式，网上可以找到很多人肉修改theme使其支持用<a href=\"http://www.mathjax.org/\" target=\"_blank\" rel=\"external\">MathJax</a>渲染公式的方法，主要分为两个步骤：</p>\n<ul>\n<li>在theme的header中插入对MathJax CDN script的引用，并配置inline math</li>\n<li>在文章中用inline math插入公式</li>\n</ul>\n<p>这个方法有两个明显的缺点：</p>\n<ul>\n<li>需要人肉进行的工作太多</li>\n<li>遇到特殊符号需要人肉escape，否则会被markdown parser吃掉</li>\n</ul>\n<p>于是开发了一个插件，实现：</p>\n<ul>\n<li>自动部署MathJax</li>\n<li>添加MathJax Tag</li>\n</ul>\n<h2 id=\"u5B89_u88C5\"><a href=\"#u5B89_u88C5\" class=\"headerlink\" title=\"安装\"></a>安装</h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ npm install hexo-math --save</span><br></pre></td></tr></table></figure>\n<h2 id=\"u521D_u59CB_u5316\"><a href=\"#u521D_u59CB_u5316\" class=\"headerlink\" title=\"初始化\"></a>初始化</h2><p>在blog文件夹中执行：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo math install</span><br></pre></td></tr></table></figure>\n<p>在<code>_config.yml</code>文件中添加：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plugins:&#10;- hexo-math</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"u4F7F_u7528\"><a href=\"#u4F7F_u7528\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p>对于不含特殊符号的公式，可以直接使用MathJax的inline math表达式.<br>如果含有特殊符号，则需要人肉escape，如<code>\\</code>之类的特殊符号在LaTex表达式中出现频率很高，这样就很麻烦，使用tag能够省不少事。</p>\n<p><strong>MathJax Inline:</strong></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Simple inline $a = b + c$.</span><br></pre></td></tr></table></figure>\n<p>效果：</p>\n<p>Simple inline $a = b + c$.</p>\n<p><strong>MathJax Block:</strong><br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$$\\frac&#123;\\partial u&#125;&#123;\\partial t&#125;</span><br><span class=\"line\">= h^2 \\left( \\frac&#123;\\partial^2 u&#125;&#123;\\partial x^2&#125; +</span><br><span class=\"line\">\\frac&#123;\\partial^2 u&#125;&#123;\\partial y^2&#125; +</span><br><span class=\"line\">\\frac&#123;\\partial^2 u&#125;&#123;\\partial z^2&#125;\\right)$$</span><br></pre></td></tr></table></figure></p>\n<p>效果：</p>\n<p>$$\\frac{\\partial u}{\\partial t}<br>= h^2 \\left( \\frac{\\partial^2 u}{\\partial x^2} +<br>\\frac{\\partial^2 u}{\\partial y^2} +<br>\\frac{\\partial^2 u}{\\partial z^2}\\right)$$</p>\n<p><strong>Tag inline:</strong></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">This equation &#123;&amp;#37; math \\cos 2\\theta = \\cos^2 \\theta - \\sin^2 \\theta =  2 \\cos^2 \\theta - 1 %&#125; is inline.</span><br></pre></td></tr></table></figure>\n<p>效果：</p>\n<p>This equation <span>$\\cos 2\\theta = \\cos^2 \\theta - \\sin^2 \\theta =  2 \\cos^2 \\theta - 1$</span><!-- Has MathJax --> is inline.</p>\n<p><strong>Tag Block:</strong><br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&amp;#37; math_block %&#125;</span><br><span class=\"line\">\\begin&#123;aligned&#125;</span><br><span class=\"line\">\\dot&#123;x&#125; &amp; = \\sigma(y-x) \\\\</span><br><span class=\"line\">\\dot&#123;y&#125; &amp; = \\rho x - y - xz \\\\</span><br><span class=\"line\">\\dot&#123;z&#125; &amp; = -\\beta z + xy</span><br><span class=\"line\">\\end&#123;aligned&#125;</span><br><span class=\"line\">&#123;&amp;#37; endmath_block %&#125;</span><br></pre></td></tr></table></figure></p>\n<p>效果：</p>\n<span>$$\\begin{aligned}\n\\dot{x} & = \\sigma(y-x) \\\\\n\\dot{y} & = \\rho x - y - xz \\\\\n\\dot{z} & = -\\beta z + xy\n\\end{aligned}$$</span><!-- Has MathJax -->\n<h2 id=\"u6E90_u4EE3_u7801\"><a href=\"#u6E90_u4EE3_u7801\" class=\"headerlink\" title=\"源代码\"></a>源代码</h2><p><a href=\"https://github.com/akfish/hexo-math\" target=\"_blank\" rel=\"external\">GitHub</a></p>\n","date":"2014-03-08T19:08:10.000Z","path":"2014/03/09/hexo-mathjax-plugin/","isDark":true,"featureColor":"#254277","featureImage":"/image/stock/3.jpg","excerpt":"","featureSwatch":{"Vibrant":{"color":"#254277","isDark":true,"contrast":13.119400726558645},"Muted":{"color":"#526c95","isDark":true,"contrast":5.699027819875463},"DarkVibrant":{"color":"#113a74","isDark":true,"contrast":13.761948622251554},"DarkMuted":{"color":"#425c7b","isDark":true,"contrast":11.860230374565882},"LightVibrant":{"color":"#f4f7fc","isDark":false,"contrast":1.0738073817947642},"LightMuted":{"color":"#8e9db6","isDark":false,"contrast":2.745663409490839}},"permalink":"http://catx.me/2014/03/09/hexo-mathjax-plugin/","json":"data/posts/2014/03/09/hexo-mathjax-plugin.json","tags":[{"name":"CoffeeScript","slug":"CoffeeScript","path":"tags/CoffeeScript/","permalink":"http://catx.me/tags/CoffeeScript/","postCount":6},{"name":"GitHub","slug":"GitHub","path":"tags/GitHub/","permalink":"http://catx.me/tags/GitHub/","postCount":6},{"name":"Hexo","slug":"Hexo","path":"tags/Hexo/","permalink":"http://catx.me/tags/Hexo/","postCount":3},{"name":"Node.Js","slug":"Node-Js","path":"tags/Node-Js/","permalink":"http://catx.me/tags/Node-Js/","postCount":3}],"categories":[{"name":"挨踢","slug":"挨踢","path":"categories/挨踢/","permalink":"http://catx.me/categories/挨踢/","postCount":17}]},"sha1":"465df2ded27fd09edad82c8c76edf17963cd7320","isDigest":true},{"type":"post","json_base":"data/posts","json":"data/posts/2014/03/01/generate-dynamic-proxy-class-at-runtime-with-ilgenerator-c-sharp.json","path":"2014/03/01/generate-dynamic-proxy-class-at-runtime-with-ilgenerator-c-sharp/","data":{"title":"用C# ILGenerator在运行时动态生成proxy","content":"<h2 id=\"u95EE_u9898_u63CF_u8FF0\"><a href=\"#u95EE_u9898_u63CF_u8FF0\" class=\"headerlink\" title=\"问题描述\"></a>问题描述</h2><p>C#中经常会遇到通过单一入口动态调用对象或服务的情况，形如：</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title\">ProxyBase</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">object</span> <span class=\"title\">Invoke</span>(<span class=\"params\"><span class=\"keyword\">object</span> someMethodRelatedInfo, <span class=\"keyword\">object</span>[] arguments</span>)</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>比如Reflection，远程服务，Host动态脚本引擎时从C#调用引擎context内的方法等等情况都可以归类于这样的模型。</p>\n<p>一种较好的工程实现就是把这些服务方法用接口定义，获得强类型的校验，避免出现不必要的bug，并便于维护。如：</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">IFooService</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">MethodWithNoReturn</span>(<span class=\"params\"></span>)</span>;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">MethodTakeParameterAndReturn</span>(<span class=\"params\"><span class=\"keyword\">int</span> a, <span class=\"keyword\">int</span> b</span>)</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于不同的后端，需要有具体的调用实现：</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">FooProxyBase</span> : <span class=\"title\">ProxyBase</span> </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">override</span> <span class=\"keyword\">object</span> <span class=\"title\">Invoke</span>(<span class=\"params\"><span class=\"keyword\">object</span> someMethodRelatedInfo, <span class=\"keyword\">object</span>[] arguments</span>)</span><br><span class=\"line\">  </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Pack to JSON and send via http</span></span><br><span class=\"line\">    <span class=\"comment\">// Or adapte and call other classes</span></span><br><span class=\"line\">    <span class=\"comment\">// Or whatever</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最终的Proxy类通过继承调用实现类，同时实现服务约定接口实现：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class FooService : FooProxyBase, IFooService</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  #region Implement IFooService</span><br><span class=\"line\">  public void MethodWithNoReturn() </span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    Invoke(\"MethodWithNoReturn\", new object[0]);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  public int MethodTakeParameterAndReturn(int a, int b)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    return Invoke(\"MethodTakeParameterAndReturn\", new object[] &#123; a, b &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  #endregion</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这样一来有一个显然的问题，Proxy类包含大量重复的代码，方法越多实现起来越费劲。这个问题的point of interest就在于Proxy类的动态生成，实现以后只需要一行代码就能替代人肉实现一个巨大的Proxy类：</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IFooService proxy = ProxyEmitter.CreateProxy&amp;lt;FooProxyBase, IFooService&amp;gt;(<span class=\"comment\">/*Constructor parameters are supported*/</span>);</span><br></pre></td></tr></table></figure>\n<p>要动态生成Proxy类有很多种方法（如生成源代码然后编译），这里采用在运行时通过Reflection获取服务接口的方法，动态生成Proxy类，最后用ILGenerator.Emit用.Net IL实现代码逻辑。</p>\n<h2 id=\"u5B9E_u73B0_u8981_u70B9\"><a href=\"#u5B9E_u73B0_u8981_u70B9\" class=\"headerlink\" title=\"实现要点\"></a>实现要点</h2><p>如何动态创建Assembly, Module, Type的框架性代码MSDN有详尽的walkthrough，不在本文讨论重点，具体实现可参考源代码。</p>\n<p>这一节记录在实现这个项目中几处逻辑的IL代码生成，有几点是必须要知道的：</p>\n<ul>\n<li>.Net CLR是基于栈的虚拟机</li>\n<li>.Net CLR（在生成C#类时）是强类型的</li>\n<li>参数顺序入栈</li>\n<li>非static method的第一个参数总是this指针</li>\n</ul>\n<p>1. 有参数的constructor</p>\n<p>在C#中很多涉及自动生成的情况（如serialization）都要求无参数的constructor，在有的情况下很让人忧桑，其实要支持有参数的constructor也是可行的。</p>\n<p>如果父类只有一个有参数的constructor，子类的constructor实现必须用足够的参数构造：</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title\">Derived</span>: <span class=\"title\">Base</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Derived</span>(<span class=\"params\"><span class=\"keyword\">int</span> may, <span class=\"keyword\">string</span> para, <span class=\"keyword\">object</span>[] meters</span>): <span class=\"title\">base</span>(<span class=\"params\">may, para, meters</span>) </span>&#123;&#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>用IL实现上述代码，需要将参数重新压栈，然后call base的ctor指针：</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">EmitCtor</span>(<span class=\"params\">TypeBuilder tBuilder, ConstructorInfo ctor</span>)</span><br><span class=\"line\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> pTypes = ctor.GetParameters().Select(p =&amp;gt; p.ParameterType).ToArray();</span><br><span class=\"line\">    <span class=\"keyword\">var</span> builder = Emitter.GetConstructor(</span><br><span class=\"line\">        tBuilder,</span><br><span class=\"line\">        MethodAttributes.Public |</span><br><span class=\"line\">        MethodAttributes.HideBySig |</span><br><span class=\"line\">        MethodAttributes.SpecialName |</span><br><span class=\"line\">        MethodAttributes.RTSpecialName,</span><br><span class=\"line\">        pTypes</span><br><span class=\"line\">        );</span><br><span class=\"line\">    <span class=\"keyword\">var</span> ilGen = builder.GetILGenerator();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// No locals</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Load all args, note arg 0 is this pointer, so must emit one more</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &amp;lt;= pTypes.Length; i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        DoEmit(ilGen, OpCodes.Ldarg_S, i);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// Call base ctor</span></span><br><span class=\"line\">    DoEmit(ilGen, OpCodes.Call, ctor);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Return</span></span><br><span class=\"line\">    DoEmit(ilGen, OpCodes.Ret);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>生成的IL形如：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IL_0000: ldarg.0</span><br><span class=\"line\">IL_0001: ldarg.1</span><br><span class=\"line\">IL_0002: ldarg.2</span><br><span class=\"line\">IL_0003: ldarg.3</span><br><span class=\"line\">IL_0004: call instance void Base::.ctor(int32, string, object)</span><br><span class=\"line\">IL_0009: ret</span><br></pre></td></tr></table></figure>\n<p>2. Array的初始化<br>由于Invoke的长相，决定了这个生成器中需要大量的生成object[]对象，并把参数装进去。<br>创建一个local variable，首先需要declare：</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ilGen.DeclareLocal(<span class=\"keyword\">typeof</span>(<span class=\"keyword\">object</span>[]))</span><br></pre></td></tr></table></figure>\n<p>每个method的运行环境里维护了一个local列表，IL代码通过index把local入栈和出栈。<br>创建Array对象，并设置到local：</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Initialize array</span></span><br><span class=\"line\"><span class=\"comment\">// IL_0006:  ldc.i4.x</span></span><br><span class=\"line\">DoEmit(ilGen, OpCodes.Ldc_I4_S, pTypes.Length);</span><br><span class=\"line\"><span class=\"comment\">// IL_0007:  newarr     [mscorlib]System.Object</span></span><br><span class=\"line\">DoEmit(ilGen, OpCodes.Newarr, <span class=\"keyword\">typeof</span>(Object));</span><br><span class=\"line\"><span class=\"comment\">// IL_000c:  stloc.1</span></span><br><span class=\"line\">DoEmit(ilGen, OpCodes.Stloc_0);</span><br><span class=\"line\">``` </span><br><span class=\"line\">对Array元素的逐条赋值由<span class=\"number\">4</span>~<span class=\"number\">5</span>条机器指令完成：</span><br><span class=\"line\"></span><br><span class=\"line\">*   ldloc.?将array入栈</span><br><span class=\"line\">*   ldc_i4_?将当前元素的index入栈</span><br><span class=\"line\">*   将需要赋给元素的值入栈（本例中为参数用ldarg_s，注意参数<span class=\"number\">0</span>为<span class=\"keyword\">this</span>指针）</span><br><span class=\"line\">*   如果是<span class=\"keyword\">value</span> type需要box</span><br><span class=\"line\">*   stelem.<span class=\"keyword\">ref</span>指令完成赋值</span><br><span class=\"line\"></span><br><span class=\"line\">```cs</span><br><span class=\"line\"><span class=\"comment\">// Now fill the array</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &amp;lt; pTypes.Length; i++)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Load the array first</span></span><br><span class=\"line\">    <span class=\"comment\">// IL_000X + 00: ldloc.0</span></span><br><span class=\"line\">    DoEmit(ilGen, OpCodes.Ldloc_0);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Push the index</span></span><br><span class=\"line\">    <span class=\"comment\">// IL_000X + 01: ldc_i4_x</span></span><br><span class=\"line\">    DoEmit(ilGen, OpCodes.Ldc_I4_S, i);</span><br><span class=\"line\">    <span class=\"comment\">// Load argument i + 1 (note that argument 0 is this pointer(?))</span></span><br><span class=\"line\">    <span class=\"comment\">// IL_000X + 02: ldarg_X</span></span><br><span class=\"line\">    DoEmit(ilGen, OpCodes.Ldarg_S, i + <span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Box value type</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pTypes[i].IsValueType)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"comment\">// IL_000X + 03: box pTypes[i]</span></span><br><span class=\"line\">        DoEmit(ilGen, OpCodes.Box, pTypes[i]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// Set arrary element</span></span><br><span class=\"line\">    <span class=\"comment\">// IL_00X + ??: stelem.ref</span></span><br><span class=\"line\">    DoEmit(ilGen, OpCodes.Stelem_Ref);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"u6E90_u4EE3_u7801_u53CA_u4F7F_u7528_u65B9_u6CD5\"><a href=\"#u6E90_u4EE3_u7801_u53CA_u4F7F_u7528_u65B9_u6CD5\" class=\"headerlink\" title=\"源代码及使用方法\"></a>源代码及使用方法</h2><p>见<a href=\"https://github.com/akfish/ProxyEmitter\" target=\"_blank\" rel=\"external\">GitHub</a>。</p>\n","date":"2014-02-28T18:50:56.000Z","path":"2014/03/01/generate-dynamic-proxy-class-at-runtime-with-ilgenerator-c-sharp/","isDark":false,"featureColor":"#a99a48","featureImage":"/image/stock/7.jpg","excerpt":"","featureSwatch":{"Vibrant":{"color":"#a99a48","isDark":false,"contrast":2.8607233160176517},"Muted":{"color":"#b7ac6a","isDark":false,"contrast":2.3019786002998246},"DarkVibrant":{"color":"#8a7133","isDark":true,"contrast":4.70318580028283},"DarkMuted":{"color":"#534c37","isDark":true,"contrast":14.371837375676147},"LightVibrant":{"color":"#e4dcc3","isDark":false,"contrast":1.3703902496024831},"LightMuted":{"color":"#aba790","isDark":false,"contrast":2.4244396488445554}},"permalink":"http://catx.me/2014/03/01/generate-dynamic-proxy-class-at-runtime-with-ilgenerator-c-sharp/","json":"data/posts/2014/03/01/generate-dynamic-proxy-class-at-runtime-with-ilgenerator-c-sharp.json","tags":[{"name":".Net","slug":"Net","path":"tags/Net/","permalink":"http://catx.me/tags/Net/","postCount":4},{"name":"compiler","slug":"compiler","path":"tags/compiler/","permalink":"http://catx.me/tags/compiler/","postCount":4}],"categories":[{"name":"挨踢","slug":"挨踢","path":"categories/挨踢/","permalink":"http://catx.me/categories/挨踢/","postCount":17}]},"sha1":"61f0d4d0a47ff1450b3bf49770effa5352818f78","isDigest":true},{"type":"post","json_base":"data/posts","json":"data/posts/2014/02/28/the-making-of-sarcasm-2-ast-generators-and-fun-with-visualization.json","path":"2014/02/28/the-making-of-sarcasm-2-ast-generators-and-fun-with-visualization/","data":{"title":"The Making Of Sarcasm (2) - AST, Generators and Fun with Visualization","content":"<p>In <a href=\"http://catx.me/2014/02/25/the-making-of-sarcasm-1/\">part 1</a> we discussed the design goals of Sarcasm and devised a grammar specification that covers most of Irony’s features.</p>\n<p>Continuing from <a href=\"https://github.com/akfish/Sarcasm/commit/15c9e6e1ef69bd1150d51af558e3a897e09accb8\" target=\"_blank\" rel=\"external\">commit 15c9e6</a>, in which I implemented the <a href=\"https://github.com/akfish/Sarcasm/blob/15c9e6e1ef69bd1150d51af558e3a897e09accb8/Sarcasm/Parser/SarcasmGrammar.cs\" target=\"_blank\" rel=\"external\">grammar specs</a> by hand with Irony, we will discuss the following topics:</p>\n<ul>\n<li>Construction of abstract syntax tree</li>\n<li>Generator workflow</li>\n<li>MarkDown generator</li>\n<li>Having some fun with visualization</li>\n</ul>\n<h2 id=\"AST_Overview\"><a href=\"#AST_Overview\" class=\"headerlink\" title=\"AST Overview\"></a>AST Overview</h2><p>After <a href=\"https://github.com/akfish/Sarcasm/blob/develop/Sarcasm/Parser/SarcasmGrammar.cs\" target=\"_blank\" rel=\"external\">grammar class</a> is implemented, the first thing you are going to do is to create a parser instance:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> language = <span class=\"keyword\">new</span> LanguageData(<span class=\"keyword\">new</span> SarcasmGrammar());</span><br><span class=\"line\"><span class=\"keyword\">var</span> parser = <span class=\"keyword\">new</span> Irony.Parsing.Parser(_language);</span><br></pre></td></tr></table></figure>\n<p>With the Parser instance, we can parse source code by simply:</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> parseTree = parser.Parse(sourceCode);</span><br><span class=\"line\"><span class=\"keyword\">var</span> parseRoot = parseTree.Root;</span><br><span class=\"line\"><span class=\"keyword\">var</span> astRoot = ParseRoot.AstNode;</span><br></pre></td></tr></table></figure>\n<p>If something is wrong with the grammar or source code, parseRoot and astRoot will be null. For now I will not go into error handling.</p>\n<p>Two kinds of trees are generated when Irony parses the source code: parsing tree and optional abstract syntax tree. To create an AST, you must do the following:</p>\n<p>1. Set language flag in grammar class’s constructor</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LanguageFlags |= LanguageFlags.CreateAst;</span><br></pre></td></tr></table></figure>\n<p>2. Create a bunch of AST node class deriving from Irony.Interpreter.Ast (also remember to add reference to assembly Irony.Interpreter.dll).</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Make your own base class will make life eaiser</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title\">SarcasmNode</span> : <span class=\"title\">AstNode</span> &#123;<span class=\"comment\">/*...*/</span>&#125;</span><br><span class=\"line\"><span class=\"comment\">// For other nodes</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Document</span> : <span class=\"title\">SarcasmNode</span> &#123;<span class=\"comment\">/*...*/</span>&#125;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">IdNode</span> : <span class=\"title\">SarcasmNode</span> &#123;<span class=\"comment\">/*...*/</span>&#125;</span><br><span class=\"line\"><span class=\"comment\">/*...*/</span></span><br></pre></td></tr></table></figure>\n<p>3. Assign AST node class to each Terminal/NonTerminal instances.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// For terminals</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> ID = <span class=\"keyword\">new</span> IdentifierTerminal(<span class=\"string\">\"ID\"</span>);</span><br><span class=\"line\">ID.AstConfig.NodeType = <span class=\"keyword\">typeof</span> (IdNode);</span><br><span class=\"line\"><span class=\"comment\">// For non-terminals</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> Directive = <span class=\"keyword\">new</span> NonTerminal(<span class=\"string\">\"Directive\"</span>, <span class=\"keyword\">typeof</span>(DirectiveNode));</span><br></pre></td></tr></table></figure>\n<p>4. Override AST node’s Init method to handle initialization.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// In AST node class</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> AstNode ChildNode;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">Init</span>(<span class=\"params\">AstContext context, ParseTreeNode treeNode</span>)</span><br><span class=\"line\">        </span>&#123;</span><br><span class=\"line\">            <span class=\"comment\">// Keep this</span></span><br><span class=\"line\">            <span class=\"keyword\">base</span>.Init(context, treeNode);</span><br><span class=\"line\">            <span class=\"comment\">// treeNode is the corresponding node in parse tree, contains information like:</span></span><br><span class=\"line\">            <span class=\"comment\">// Token</span></span><br><span class=\"line\">            <span class=\"keyword\">var</span> token = treeNode.Token;</span><br><span class=\"line\">            <span class=\"comment\">// Term</span></span><br><span class=\"line\">            <span class=\"keyword\">var</span> term = treeNode.Term;</span><br><span class=\"line\">            <span class=\"comment\">// Child nodes</span></span><br><span class=\"line\">            <span class=\"keyword\">var</span> nodes = treeNode.GetMappedChildNodes();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// Set AsString to a human readable format. It will be used to display AST in Irony.GrammarExplorer</span></span><br><span class=\"line\">            AsString = <span class=\"string\">\"Id: \"</span> + token.Text;</span><br><span class=\"line\">            <span class=\"comment\">// Use AddChild to build tree structure, it returns an AstNode instance of child's AST node </span></span><br><span class=\"line\">            ChildNode = AddChild(<span class=\"keyword\">string</span>.Empty, nodes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n<p>That’s almost all you need to know about how to construct an AST. However, if you mess it up, things can get ugly since the debug information is extremely not helpful. The most common exception on can get is:</p>\n<blockquote>\n<p>System.NullReferenceException: Object reference not set to an instance of an object.<br>at Irony.Ast.AstBuilder.BuildAst(ParseTreeNode parseNode) in f:\\Dev\\Tool\\Irony_2013_12_12\\Irony\\Ast\\AstBuilder.cs:line 97<br>This will not help you at all. But I will tell you that this always has to do with forgetting to set AST node type to one of your Terminals/Non-Terminals.</p>\n</blockquote>\n<p>Here are some tips I learned in the hard way (the only way mostly, since Irony’s documentation is poor):</p>\n<ul>\n<li>Assign AST node type to all Terminals/NonTerminals, including any intermediate/temporary ones.</li>\n<li>Except the ones marked as transient. They will not be created at all.</li>\n<li>CommentTerminals will NOT be mapped to AST at all. You will get the above error regardless the AST node type is set or not.</li>\n</ul>\n<h2 id=\"Generator_Workflow\"><a href=\"#Generator_Workflow\" class=\"headerlink\" title=\"Generator Workflow\"></a>Generator Workflow</h2><p>AST marks the watershed between compiler’s front end and back end. Although there’re still some work (e.g. type validation and  semantic analysis) left to be done, we can already generate something with this AST now. The most commonly used method here is the <a href=\"http://en.wikipedia.org/wiki/Visitor_pattern\" target=\"_blank\" rel=\"external\">visitor pattern</a>:</p>\n<p>1. Declare a interface for Visitor, one overload for each AST node</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title\">ISarcasmVisitor</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Visit</span>(<span class=\"params\">IdNode node</span>)</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Visit</span>(<span class=\"params\">Document node</span>)</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Visit</span>(<span class=\"params\">StringValueNode node</span>)</span>;</span><br><span class=\"line\">    <span class=\"comment\">// others</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2. Add virtual/abstract method to AST base class and implement in all derived class</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title\">SarcasmNode</span> : <span class=\"title\">AstNode</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">Accept</span>(<span class=\"params\">ISarcasmVisitor visitor</span>)</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Document</span> : <span class=\"title\">SarcasmNode</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">override</span> <span class=\"keyword\">void</span> <span class=\"title\">Accept</span>(<span class=\"params\">ISarcasmVisitor visitor</span>)</span><br><span class=\"line\">    </span>&#123;</span><br><span class=\"line\">        visitor.Visit(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>3. Then we can create a generator by implement specific ISarcasmVisitor for different workflow, not only for target code generation but also outlining, semantic analysis.</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title\">TargetGenerator</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> SarcasmParser Parser &#123; <span class=\"keyword\">get</span>; <span class=\"keyword\">set</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"title\">TargetGenerator</span>(<span class=\"params\">SarcasmParser parser</span>)</span><br><span class=\"line\">    </span>&#123;</span><br><span class=\"line\">        Parser = parser;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">BeforeVisitor</span>(<span class=\"params\">StreamWriter writer, ISarcasmVisitor visitor</span>) </span>&#123; &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">abstract</span> ISarcasmVisitor <span class=\"title\">MakeVisitor</span>(<span class=\"params\">StreamWriter writer</span>)</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">AfterVisitor</span>(<span class=\"params\">StreamWriter writer, ISarcasmVisitor visitor</span>) </span>&#123; &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">bool</span> <span class=\"title\">Generate</span>(<span class=\"params\">StreamReader sourceStream, StreamWriter targetStream</span>)</span><br><span class=\"line\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// Parse first</span></span><br><span class=\"line\">        Parser.Parse(sourceStream);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (Parser.IsValid)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> visitor = MakeVisitor(targetStream);</span><br><span class=\"line\">            BeforeVisitor(targetStream, visitor);</span><br><span class=\"line\">            <span class=\"comment\">// Visit AST</span></span><br><span class=\"line\">            Parser.Document.Accept(visitor);</span><br><span class=\"line\">            AfterVisitor(targetStream, visitor);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        targetStream.Flush();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Parser.IsValid;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"MarkDown_Generation\"><a href=\"#MarkDown_Generation\" class=\"headerlink\" title=\"MarkDown Generation\"></a>MarkDown Generation</h2><p>MarkDown generation for Sarcasm is very straight forward, since the syntax is in MarkDown. All I need to do is remove comment delimiters, add correct amount of line endings, format grammar rule into block and escape some special characters.</p>\n<p>Again I won’t bother with the details here. Just see <a href=\"https://github.com/akfish/Sarcasm/blob/develop/Sarcasm/Generator/MarkDownGenerator.cs\" target=\"_blank\" rel=\"external\">the code</a> for yourself.</p>\n<h2 id=\"Something_Fun_with_Visualization\"><a href=\"#Something_Fun_with_Visualization\" class=\"headerlink\" title=\"Something Fun with Visualization\"></a>Something Fun with Visualization</h2><p>The original plan was to start generate C# parser class from here. Then I found an interesting project <a href=\"http://arborjs.org\" target=\"_blank\" rel=\"external\">arbor.js</a> (especially its <a href=\"http://arborjs.org/halfviz/\" target=\"_blank\" rel=\"external\">halfviz</a> demo) and decided to do something fun with it. The idea is to make a better tool for debug. What debug information is better than a visualized one?</p>\n<p>The halfviz demo converts a simple language called HalfTone to a node network. With the generator framework in place, it took me less than half an hour to <a href=\"https://github.com/akfish/Sarcasm/blob/feature/Visualization/Sarcasm/Generator/HalfToneGenerator.cs\" target=\"_blank\" rel=\"external\">generate node</a> representation from Sarcasm grammar source file. This can be used to visualize references between terminals and non-terminals:</p>\n<p><a href=\"http://catx.me/wordpress/wp-content/uploads/2014/02/vis.png\"><img src=\"/images/4be5b8b991d3bcafb280141940e1291eedbaf612.png\" alt=\"sarcasm-vis\"></a></p>\n<p>You can play with it live <a href=\"http://arborjs.org/halfviz/#/NjM0OA\" target=\"_blank\" rel=\"external\">here</a>. It looks more confusing in this form, for now. But with some interaction (filtering, folding, highlighting for example), it can help develops quickly navigate though the grammar.<br>Here’s another concept of how to visualize grammar related errors in this form (click to enlarge):<br><a href=\"http://catx.me/wordpress/wp-content/uploads/2014/02/concept.png\"><img src=\"/images/a645da29630a43fdaaedfc76d6a683eeeb522ebf.png\" alt=\"sarcasm-concept\"></a></p>\n<p>Imagine view build errors in Visual Studio with this graph and navigate to the line that is responsible by click on the node. I definitely will try to create something like that later when I begin to make tool chain for Sarcasm.</p>\n","date":"2014-02-27T18:46:18.000Z","path":"2014/02/28/the-making-of-sarcasm-2-ast-generators-and-fun-with-visualization/","isDark":true,"featureColor":"#3838a4","featureImage":"/image/stock/2.jpg","excerpt":"","featureSwatch":{"Vibrant":{"color":"#3838a4","isDark":true,"contrast":11.34232025151814},"Muted":{"color":"#5b5c4b","isDark":true,"contrast":13.55058952563751},"DarkVibrant":{"color":"#392d1b","isDark":true,"contrast":16.396358734600554},"DarkMuted":{"color":"#6a6256","isDark":true,"contrast":10.115562350289883},"LightVibrant":{"color":"#e8dbc6","isDark":false,"contrast":1.3654796219696164},"LightMuted":{"color":"#afabaf","isDark":false,"contrast":2.266109189190235}},"permalink":"http://catx.me/2014/02/28/the-making-of-sarcasm-2-ast-generators-and-fun-with-visualization/","json":"data/posts/2014/02/28/the-making-of-sarcasm-2-ast-generators-and-fun-with-visualization.json","tags":[{"name":".Net","slug":"Net","path":"tags/Net/","permalink":"http://catx.me/tags/Net/","postCount":4},{"name":"C++","slug":"C","path":"tags/C/","permalink":"http://catx.me/tags/C/","postCount":2},{"name":"Markdown","slug":"Markdown","path":"tags/Markdown/","permalink":"http://catx.me/tags/Markdown/","postCount":1},{"name":"Sarcasm","slug":"Sarcasm","path":"tags/Sarcasm/","permalink":"http://catx.me/tags/Sarcasm/","postCount":1},{"name":"compiler","slug":"compiler","path":"tags/compiler/","permalink":"http://catx.me/tags/compiler/","postCount":4}],"categories":[{"name":"挨踢","slug":"挨踢","path":"categories/挨踢/","permalink":"http://catx.me/categories/挨踢/","postCount":17}]},"sha1":"0f8aa688c5242019beddec5656c7557b72ce5811","isDigest":true},{"type":"post","json_base":"data/posts","json":"data/posts/2014/02/25/the-making-of-sarcasm-1.json","path":"2014/02/25/the-making-of-sarcasm-1/","data":{"title":"The Making Of Sarcasm (1) - Design Goals And Grammar","content":"<h2 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a>Introduction</h2><p>This is not a tutorial on how to use <a href=\"https://irony.codeplex.com/\" target=\"_blank\" rel=\"external\">Irony.net</a>. When I am done with this series of articles, hopefully we will never need to deal with Irony directly ever again.</p>\n<p>In case you didn’t know what Irony is, here is the introduction on its official site:</p>\n<blockquote>\n<p><strong>Irony</strong> is a development kit for implementing languages on .NET platform. Unlike most existing yacc/lex-style solutions Irony does not employ any scanner or parser code generation from grammar specifications written in a specialized meta-language. In Irony the target language grammar is coded directly in c# using operator overloading to express grammar constructs. Irony’s scanner and parser modules use the grammar encoded as c# class to control the parsing process.</p>\n</blockquote>\n<p>Looks fantastic. However, after I tried for days to implement CoffeeScript grammar with it, I encountered some issues:</p>\n<ul>\n<li>While constructing grammar with C# directly sounds cool, the syntax is just not as clean and efficient as a special design DSL would be.</li>\n<li>There are absolutely no compile-time checking on grammar. You have to compile it into dll first, then load it with Irony.GrammarExplorer.</li>\n<li>It is extremely hard, if not impossible, to track any grammar errors back to source code.</li>\n<li>On top of that, debug information on Shift-Reduce and Reduce-Reduce conflict is almost unreadable for a complex grammar.</li>\n</ul>\n<p>It’s a nice concept with poor tooling, which makes it scale poorly as the complexity of grammar grows. After some painstaking efforts to make my CoffeeScript parser to work, I finally begin to do something about it. I decide to create:</p>\n<blockquote>\n<p><strong>Sarcasm</strong>, an EBNF-like DSL that generates Irony.</p>\n</blockquote>\n<p>The design goals are to:</p>\n<ul>\n<li>Implement a DSL that allow developers to define grammar in a more clean and efficient syntax that looks very much like EBNF notation.</li>\n<li>Generate Irony grammar implementation (in C#) and a nice formatted grammar specification document (in MarkDown)</li>\n<li>Enable compile-time error checking and grammar validation</li>\n<li>Trace any errors back to the source code</li>\n<li>Improve the readability of debug information for grammar conflicts</li>\n<li>Provide necessary Visual Studio languages services, templates and tools</li>\n</ul>\n<h2 id=\"Sarcasm_Workflow\"><a href=\"#Sarcasm_Workflow\" class=\"headerlink\" title=\"Sarcasm Workflow\"></a>Sarcasm Workflow</h2><ol>\n<li>Developer writes grammar specification file (.sarc)</li>\n<li>Compiler checks for syntax error and generates both Irony grammar class (in C#) and spec docs (in MarkDown)</li>\n<li>VS continues build process</li>\n<li>If build failed, Sarcasm tools filters though all error messages, and map related errors back to specific tokens in .sarc file.</li>\n<li>If build succeeded,Sarcasm toolsloads the assembly and validates grammar.</li>\n<li>Sarcasm toolstranslates any grammar conflicts, errors into a readable format and trace back to specific rule in .sarc file.<br>The entire workflow should be seamlessly integrated with Visual Studio.</li>\n</ol>\n<h2 id=\"Sarcasm_Grammar\"><a href=\"#Sarcasm_Grammar\" class=\"headerlink\" title=\"Sarcasm Grammar\"></a>Sarcasm Grammar</h2><p>In a nutshell, the Sarcasm grammar is a hybrid of MakeDown and modified EBNF notation. Here’s a quick snippet:<span style=\"line-height: 1.5em;\"></span></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"header\"># H1</span></span><br><span class=\"line\"></span><br><span class=\"line\">/*</span><br><span class=\"line\">Block comment</span><br><span class=\"line\">*/</span><br><span class=\"line\"></span><br><span class=\"line\">// Single Line Comment</span><br><span class=\"line\"></span><br><span class=\"line\">// Directive</span><br><span class=\"line\">@class SarcasmGrammar</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"header\">## H2</span></span><br><span class=\"line\"></span><br><span class=\"line\">// Declarations</span><br><span class=\"line\">ID      = new IdentifierTerminal(\"ID\");</span><br><span class=\"line\">STRING  = new StringLiteral(\"STRING\", \"\\\"\", StringOptions.AllowsAllEscapes);</span><br><span class=\"line\"></span><br><span class=\"line\">// Production Rules</span><br><span class=\"line\">SimpleValue := STRING | ID;  </span><br><span class=\"line\"></span><br><span class=\"line\">// Repeat</span><br><span class=\"line\">Ids := ID&#123;&#125;;</span><br><span class=\"line\">Ids := ID*;</span><br><span class=\"line\">Ids := ID?;</span><br><span class=\"line\">Ids := ID+;</span><br><span class=\"line\"></span><br><span class=\"line\">// Repeat with delimiters</span><br><span class=\"line\">Ids := ID&#123;\",\"&#125;;</span><br><span class=\"line\">Ids := ID*(\".\");</span><br><span class=\"line\">Ids := ID+(\",\");</span><br><span class=\"line\"><span class=\"header\">### H3</span></span><br></pre></td></tr></table></figure>\n<p>As you can see, the grammar consists of:</p>\n<ul>\n<li>MarkDown headers (start with one or more <span style=\"text-decoration: underline;\">#</span>). Directly used for outlining.</li>\n<li>Comments (single line and block). All other text contents go into comments. MarkDown syntax can be used in comments.</li>\n<li>Directives (starting with <span style=\"text-decoration: underline;\">@)</span>. Configures compiler behaviors like generated class names.</li>\n<li>Declarations. Declare and initialize grammar terminals.</li>\n<li>Production rules. Specifies the grammar rules.<br>I won’t go into full details here. But you can see for yourself:</li>\n</ul>\n<p>Here is the <a href=\"https://gist.github.com/akfish/9167407#file-sarcasm-sarc\" target=\"_blank\" rel=\"external\">full grammar of Sarcasm writing in Sarcasm</a>.</p>\n<p>And here is the <a href=\"https://gist.github.com/akfish/9167407#file-sarcasm-md\" target=\"_blank\" rel=\"external\">MarkDownspecification documentation generated from that file</a></p>\n<p>While the<a href=\"https://github.com/akfish/Sarcasm\" target=\"_blank\" rel=\"external\">project</a>is still in early developing stage, the grammar is mostly completed. I should be able to bootstrap it in a day or two.</p>\n","date":"2014-02-24T20:13:46.000Z","path":"2014/02/25/the-making-of-sarcasm-1/","isDark":true,"featureColor":"#e46753","featureImage":"/image/stock/1.jpg","excerpt":"","featureSwatch":{"Vibrant":{"color":"#e46753","isDark":true,"contrast":3.3464676687814303},"Muted":{"color":"#676767","isDark":true,"contrast":5.656311837697813},"DarkVibrant":{"color":"#721f11","isDark":true,"contrast":11.305374415421051},"DarkMuted":{"color":"#393939","isDark":true,"contrast":15.601542416452443},"LightVibrant":{"color":"#e5826f","isDark":false,"contrast":2.7082115476623927},"LightMuted":{"color":"#a4a4a4","isDark":false,"contrast":2.4926545004666014}},"permalink":"http://catx.me/2014/02/25/the-making-of-sarcasm-1/","json":"data/posts/2014/02/25/the-making-of-sarcasm-1.json","tags":[{"name":".Net","slug":"Net","path":"tags/Net/","permalink":"http://catx.me/tags/Net/","postCount":4},{"name":"compiler","slug":"compiler","path":"tags/compiler/","permalink":"http://catx.me/tags/compiler/","postCount":4}],"categories":[{"name":"挨踢","slug":"挨踢","path":"categories/挨踢/","permalink":"http://catx.me/categories/挨踢/","postCount":17}]},"sha1":"1d80d4f4f0a7bfa3e74288a281e69a0a4a1b4406","isDigest":true}],"sha1":"dcd6352838b564adec18753edae72310595d4d9a"}