{"type":"post","json_base":"data/posts","json":"data/posts/2013/10/19/git-custom-transfer-protocol-1.json","path":"2013/10/19/git-custom-transfer-protocol-1/","data":{"title":"Git私有传输协议实现-接口篇(1)","content":"<p>Git默认支持http, https, ssh协议，同时也提供了扩展私有协议的方法，文档<a href=\"https://www.kernel.org/pub/software/scm/git/docs/git-remote-helpers.html\" target=\"_blank\" rel=\"external\">git-remote-helpers</a>给出了详细的spec。</p>\n<p>比如要实现一种协议，把git repository存储（可加密）到私人的email邮箱中，以存储一些不便于host到GitHub的私人repo，同时免去购买主机/服务器的成本和维护带来的麻烦，Repository的clone url格式定义为<code>mail://your@email.com:repo_name</code>。</p>\n<h2 id=\"u8C03_u7528\"><a href=\"#u8C03_u7528\" class=\"headerlink\" title=\"调用\"></a>调用</h2><p>使用git命令clone, 现在什么都没实现，所以理所当然的报错：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git clone mail://akfish@gmail.com:foo&#10;fatal: Unable to find remote helper for &#39;mail&#39;</span><br></pre></td></tr></table></figure></p>\n<p>根据文档的描述：</p>\n<blockquote>\n<p>When git encounters a URL of the form &lt;transport&gt;://&lt;address&gt;, where &lt;transport&gt; is a protocol that it cannot handle natively, it automatically invokes git remote-&lt;transport&gt; with the full URL as the second argument. If such a URL is encountered directly on the command line, the first argument is the same as the second, and if it is encountered in a configured remote, the first argument is the name of that remote.</p>\n</blockquote>\n<p>即git会把url中<code>mail://</code>映射到调用命令<code>git-remote-mail</code>，所以只需要用任何开发语言实现一个标准输入输出的命令行程序，满足文档中定义的命令格式，放在git能搜寻到的位置，就能让git支持私有协议（注意python在windows下存在stdout无法被重定向的问题，无法和git正确通信）。本例中用C#实现，创建控制台程序git-remote-mail：</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> System;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Collections.Generic;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Linq;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Text;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Threading.Tasks;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">git_remote_mail</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">class</span> <span class=\"title\">Program</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">Main</span>(<span class=\"params\"><span class=\"keyword\">string</span>[] args</span>)</span><br><span class=\"line\">        </span>&#123;</span><br><span class=\"line\">            Logger logger = <span class=\"keyword\">new</span> Logger(<span class=\"string\">\"git-remote-mail.txt\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            logger.Log(<span class=\"string\">\"args: \"</span> + String.Join(<span class=\"string\">\", \"</span>, args));</span><br><span class=\"line\"></span><br><span class=\"line\">            logger.Dispose();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>再次执行clone，错误提示消失，由于这个脚本什么事情也没做，所以当然也就什么都不会发生。stdin和stdout被用于与git通信，不会显示出来。如果需要输出消息，write到stderr，或者产生一个日志文件来记录，Logger类实现了相应的功能，具体代码见<a href=\"https://github.com/akfish/git-mail/blob/master/git-remote-mail/Logger.cs\" target=\"_blank\" rel=\"external\">Logger.cs</a>。执行clone命令后，输出为：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[2013/10/20 22:07:02]Open log file git-remote-mail.txt&#10;[2013/10/20 22:07:02]args: origin, mail://akfish@gmail.com:foo&#10;[2013/10/20 22:07:02]Close log file</span><br></pre></td></tr></table></figure></p>\n<p>可以看到，在调用的时候，还传入了两个参数：origin和mail://akfish@gmail.com:foo，根据文档：</p>\n<blockquote>\n<p>Remote helper programs are invoked with one or (optionally) two arguments. The first argument specifies a remote repository as in git; it is either the name of a configured remote or a URL. The second argument specifies a URL; it is usually of the form &lt;transport&gt;://&lt;address&gt;, but any arbitrary string is possible.</p>\n</blockquote>\n<p>参数的数量为1~2个，第一个参数为repo的名字或者url，第二个参数如果存在，为repo的url。</p>\n<h2 id=\"u547D_u4EE4_u6D41\"><a href=\"#u547D_u4EE4_u6D41\" class=\"headerlink\" title=\"命令流\"></a>命令流</h2><p>Git通过stdin向remote helper发送命令，一行一个，第一个命令总是<em>capabilities</em>。Remote helper需要通过stdout返回支持的capabilities，每行一个，以空行结束。Capabilities代表helper支持哪些命令子集，如fetch需要支持<em>connect, fetch, import</em>，详细的列表在文档里有列出。</p>\n<p>命令流通常以空行结束，但在某些情况下空行后会跟着其它协议的payload（如pack），具体参见command的具体说明。要注意的是命令流用的是linux-style line ending，即以<em>\\n</em>结尾，如果使用<em>Console.WriteLine</em>产生的是DOS line ending（<em>\\r\\n</em>），则不能正确工作。<em>\n</em></p>\n<p>增加代码响应capabilities命令：</p>\n<figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//.... </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">Main</span>(<span class=\"params\"><span class=\"keyword\">string</span>[] args</span>)</span><br><span class=\"line\"></span>&#123;</span><br><span class=\"line\">    Logger logger = <span class=\"keyword\">new</span> Logger(<span class=\"string\">\"git-remote-mail.txt\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    logger.Log(<span class=\"string\">\"args: \"</span> + String.Join(<span class=\"string\">\", \"</span>, args));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">string</span> line;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> exitCode = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        line = Console.ReadLine();</span><br><span class=\"line\"></span><br><span class=\"line\">        logger.Log(<span class=\"string\">\"&amp;gt;&amp;gt;\"</span> + line);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">string</span>.IsNullOrEmpty(line))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            logger.Log(<span class=\"string\">\"Command stream terminated\"</span>);</span><br><span class=\"line\">            exitCode = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (line.StartsWith(<span class=\"string\">\"capabilities\"</span>))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Console.Write(<span class=\"string\">\"connect\\n\"</span>);</span><br><span class=\"line\">            Console.Write(<span class=\"string\">\"fetch\\n\"</span>);</span><br><span class=\"line\">            Console.Write(<span class=\"string\">\"import\\n\"</span>);</span><br><span class=\"line\">            Console.Write(<span class=\"string\">\"\\n\"</span>);</span><br><span class=\"line\">            logger.Log(<span class=\"string\">\"&amp;lt;&amp;lt;connect, fetch, import\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            logger.Log(<span class=\"string\">\"Unhandled command. Exit\"</span>);</span><br><span class=\"line\">            exitCode = <span class=\"number\">1</span>;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    logger.Dispose();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> exitCode;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br></pre></td></tr></table></figure>\n<p>输出为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[2013/10/20 22:28:53]Open log file git-remote-mail.txt&#10;[2013/10/20 22:28:53]args: origin, mail://akfish@gmail.com:foo&#10;[2013/10/20 22:28:53]&#38;gt;&#38;gt;capabilities&#10;[2013/10/20 22:28:53]&#38;lt;&#38;lt;connect, fetch, import&#10;[2013/10/20 22:28:53]&#38;gt;&#38;gt;connect git-upload-pack&#10;[2013/10/20 22:28:53]Unhandled command. Exit&#10;[2013/10/20 22:28:53]Close log file</span><br></pre></td></tr></table></figure>\n<p>表明命令流已经成功初始化，git继续发出connect命令开始clone的工作。</p>\n<p>接口部分就这么简单，接下来的工作就是根据文档的描述，响应具体的命令，完成协议的具体设计。</p>\n<h2 id=\"u66F4_u591A_u53C2_u8003_u8D44_u6599\"><a href=\"#u66F4_u591A_u53C2_u8003_u8D44_u6599\" class=\"headerlink\" title=\"更多参考资料\"></a>更多参考资料</h2><p>Git的repo中包含了大量文档，都是很好的参考资料</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git clone https://github.com/git/git&#10;$ cd git/Documentation&#10;$ grep -nRHI &#34;receive-pack&#34; *</span><br></pre></td></tr></table></figure>\n<p>会给出这些文档：</p>\n<ul>\n<li><a href=\"https://github.com/git/git/blob/master/Documentation/technical/http-protocol.txt\" target=\"_blank\" rel=\"external\">http-protocol</a></li>\n<li><a href=\"https://github.com/git/git/blob/master/Documentation/technical/pack-heuristics.txt\" target=\"_blank\" rel=\"external\">pack-heuristics</a></li>\n<li><a href=\"https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt\" target=\"_blank\" rel=\"external\">pack-protocol</a></li>\n<li><a href=\"https://github.com/git/git/blob/master/Documentation/technical/protocol-capabilities.txt\" target=\"_blank\" rel=\"external\">protocol capabilities</a></li>\n<li><a href=\"https://github.com/git/git/blob/master/Documentation/technical/send-pack-pipeline.txt\" target=\"_blank\" rel=\"external\"><code>send-pack</code> pipeline</a></li>\n</ul>\n<p>以下文档是相关的后端命令，作为补充：</p>\n<ul>\n<li><a href=\"https://github.com/git/git/blob/master/Documentation/git-http-backend.txt\" target=\"_blank\" rel=\"external\"><code>git-http-backend</code></a></li>\n<li><a href=\"https://github.com/git/git/blob/master/Documentation/git-receive-pack.txt\" target=\"_blank\" rel=\"external\"><code>git-receive-pack</code></a></li>\n<li><a href=\"https://github.com/git/git/blob/master/Documentation/git-remote-ext.txt\" target=\"_blank\" rel=\"external\"><code>git-remote-ext</code></a></li>\n<li><a href=\"https://github.com/git/git/blob/master/Documentation/git-send-pack.txt\" target=\"_blank\" rel=\"external\"><code>git-send-pack</code></a></li>\n<li><a href=\"https://github.com/git/git/blob/master/Documentation/gitremote-helpers.txt\" target=\"_blank\" rel=\"external\"><code>git-remote-helpers</code></a></li>\n</ul>\n<p>查看源代码中与传输协议相关的commit：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git clone https://github.com/git/git&#10;$ cd git&#10;$ git log -Stransfer</span><br></pre></td></tr></table></figure>\n<p>可以参见以下commits：</p>\n<ul>\n<li><a href=\"http://github.com/git/git/commit/4bc444eb64173f770c1d1dba2ed3db393c2a9b18\" target=\"_blank\" rel=\"external\">commit 4bc444</a> (Support FTP-over-SSL/TLS for regular FTP)</li>\n<li><a href=\"https://github.com/git/git/commit/daebaa78137d59693a808c1f0bdec0ecb40fc12e\" target=\"_blank\" rel=\"external\">commit daebaa</a> (upload/receive-pack: allow hiding ref hierarchies )</li>\n<li><a href=\"http://github.com/git/git/commit/745f7a8cacae55df3e00507344d8db2a31eb57e8\" target=\"_blank\" rel=\"external\">commit 745f7a</a> (fetch-pack: move core code to libgit.a)</li>\n<li><a href=\"http://github.com/git/git/commit/fe0435011cfc5f0c15bbd4548ce0015f5b8ad430\" target=\"_blank\" rel=\"external\">commit fe0435</a> (Add persistent-https to contrib)<br>&nbsp;</li>\n</ul>\n","date":"2013-10-19T10:47:12.000Z","path":"2013/10/19/git-custom-transfer-protocol-1/","isDark":true,"featureColor":"#254277","featureImage":"/image/stock/3.jpg","excerpt":"","featureSwatch":{"Vibrant":{"color":"#254277","isDark":true,"contrast":13.119400726558645},"Muted":{"color":"#526c95","isDark":true,"contrast":5.699027819875463},"DarkVibrant":{"color":"#113a74","isDark":true,"contrast":13.761948622251554},"DarkMuted":{"color":"#425c7b","isDark":true,"contrast":11.860230374565882},"LightVibrant":{"color":"#f4f7fc","isDark":false,"contrast":1.0738073817947642},"LightMuted":{"color":"#8e9db6","isDark":false,"contrast":2.745663409490839}},"permalink":"http://catx.me/2013/10/19/git-custom-transfer-protocol-1/","json":"data/posts/2013/10/19/git-custom-transfer-protocol-1.json","tags":[{"name":"git","slug":"git","path":"tags/git/","permalink":"http://catx.me/tags/git/","postCount":2},{"name":"gmail","slug":"gmail","path":"tags/gmail/","permalink":"http://catx.me/tags/gmail/","postCount":1},{"name":"python","slug":"python","path":"tags/python/","permalink":"http://catx.me/tags/python/","postCount":1}],"categories":[{"name":"挨踢","slug":"挨踢","path":"categories/挨踢/","permalink":"http://catx.me/categories/挨踢/","postCount":17}]},"sha1":"ee0558eb63a9941311f470d53d2d24c21c635d46","prev":{"title":"Hexo MathJax插件","content":"<div id=\"badge-container-akfish-hexo-math-6e264f5\" class=\"hexo-github\" style=\"width: 100%\"></div>\n<script src=\"/hexo-github/badge.js\"></script>\n<script type=\"text/javascript\">\n  loadStyle(\"/hexo-github/style.css\");\n  loadStyle(\"/hexo-github/octicons/octicons.css\");\n  new Badge(\"#badge-container-akfish-hexo-math-6e264f5\", \"akfish\", \"hexo-math\", \"6e264f5\", false);\n</script>\n\n<h2 id=\"u4ECB_u7ECD\"><a href=\"#u4ECB_u7ECD\" class=\"headerlink\" title=\"介绍\"></a>介绍</h2><p>Hexo不支持数学公式，网上可以找到很多人肉修改theme使其支持用<a href=\"http://www.mathjax.org/\" target=\"_blank\" rel=\"external\">MathJax</a>渲染公式的方法，主要分为两个步骤：</p>\n<ul>\n<li>在theme的header中插入对MathJax CDN script的引用，并配置inline math</li>\n<li>在文章中用inline math插入公式</li>\n</ul>\n<p>这个方法有两个明显的缺点：</p>\n<ul>\n<li>需要人肉进行的工作太多</li>\n<li>遇到特殊符号需要人肉escape，否则会被markdown parser吃掉</li>\n</ul>\n<p>于是开发了一个插件，实现：</p>\n<ul>\n<li>自动部署MathJax</li>\n<li>添加MathJax Tag</li>\n</ul>\n<h2 id=\"u5B89_u88C5\"><a href=\"#u5B89_u88C5\" class=\"headerlink\" title=\"安装\"></a>安装</h2><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ npm install hexo-math --save</span><br></pre></td></tr></table></figure>\n<h2 id=\"u521D_u59CB_u5316\"><a href=\"#u521D_u59CB_u5316\" class=\"headerlink\" title=\"初始化\"></a>初始化</h2><p>在blog文件夹中执行：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo math install</span><br></pre></td></tr></table></figure>\n<p>在<code>_config.yml</code>文件中添加：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plugins:&#10;- hexo-math</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"u4F7F_u7528\"><a href=\"#u4F7F_u7528\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p>对于不含特殊符号的公式，可以直接使用MathJax的inline math表达式.<br>如果含有特殊符号，则需要人肉escape，如<code>\\</code>之类的特殊符号在LaTex表达式中出现频率很高，这样就很麻烦，使用tag能够省不少事。</p>\n<p><strong>MathJax Inline:</strong></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Simple inline $a = b + c$.</span><br></pre></td></tr></table></figure>\n<p>效果：</p>\n<p>Simple inline $a = b + c$.</p>\n<p><strong>MathJax Block:</strong><br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$$\\frac&#123;\\partial u&#125;&#123;\\partial t&#125;</span><br><span class=\"line\">= h^2 \\left( \\frac&#123;\\partial^2 u&#125;&#123;\\partial x^2&#125; +</span><br><span class=\"line\">\\frac&#123;\\partial^2 u&#125;&#123;\\partial y^2&#125; +</span><br><span class=\"line\">\\frac&#123;\\partial^2 u&#125;&#123;\\partial z^2&#125;\\right)$$</span><br></pre></td></tr></table></figure></p>\n<p>效果：</p>\n<p>$$\\frac{\\partial u}{\\partial t}<br>= h^2 \\left( \\frac{\\partial^2 u}{\\partial x^2} +<br>\\frac{\\partial^2 u}{\\partial y^2} +<br>\\frac{\\partial^2 u}{\\partial z^2}\\right)$$</p>\n<p><strong>Tag inline:</strong></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">This equation &#123;&amp;#37; math \\cos 2\\theta = \\cos^2 \\theta - \\sin^2 \\theta =  2 \\cos^2 \\theta - 1 %&#125; is inline.</span><br></pre></td></tr></table></figure>\n<p>效果：</p>\n<p>This equation <span>$\\cos 2\\theta = \\cos^2 \\theta - \\sin^2 \\theta =  2 \\cos^2 \\theta - 1$</span><!-- Has MathJax --> is inline.</p>\n<p><strong>Tag Block:</strong><br><figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&amp;#37; math_block %&#125;</span><br><span class=\"line\">\\begin&#123;aligned&#125;</span><br><span class=\"line\">\\dot&#123;x&#125; &amp; = \\sigma(y-x) \\\\</span><br><span class=\"line\">\\dot&#123;y&#125; &amp; = \\rho x - y - xz \\\\</span><br><span class=\"line\">\\dot&#123;z&#125; &amp; = -\\beta z + xy</span><br><span class=\"line\">\\end&#123;aligned&#125;</span><br><span class=\"line\">&#123;&amp;#37; endmath_block %&#125;</span><br></pre></td></tr></table></figure></p>\n<p>效果：</p>\n<span>$$\\begin{aligned}\n\\dot{x} & = \\sigma(y-x) \\\\\n\\dot{y} & = \\rho x - y - xz \\\\\n\\dot{z} & = -\\beta z + xy\n\\end{aligned}$$</span><!-- Has MathJax -->\n<h2 id=\"u6E90_u4EE3_u7801\"><a href=\"#u6E90_u4EE3_u7801\" class=\"headerlink\" title=\"源代码\"></a>源代码</h2><p><a href=\"https://github.com/akfish/hexo-math\" target=\"_blank\" rel=\"external\">GitHub</a></p>\n","date":"2014-03-08T19:08:10.000Z","path":"2014/03/09/hexo-mathjax-plugin/","isDark":true,"featureColor":"#254277","featureImage":"/image/stock/3.jpg","excerpt":"","featureSwatch":{"Vibrant":{"color":"#254277","isDark":true,"contrast":13.119400726558645},"Muted":{"color":"#526c95","isDark":true,"contrast":5.699027819875463},"DarkVibrant":{"color":"#113a74","isDark":true,"contrast":13.761948622251554},"DarkMuted":{"color":"#425c7b","isDark":true,"contrast":11.860230374565882},"LightVibrant":{"color":"#f4f7fc","isDark":false,"contrast":1.0738073817947642},"LightMuted":{"color":"#8e9db6","isDark":false,"contrast":2.745663409490839}},"permalink":"http://catx.me/2014/03/09/hexo-mathjax-plugin/","json":"data/posts/2014/03/09/hexo-mathjax-plugin.json","tags":[{"name":"CoffeeScript","slug":"CoffeeScript","path":"tags/CoffeeScript/","permalink":"http://catx.me/tags/CoffeeScript/","postCount":6},{"name":"GitHub","slug":"GitHub","path":"tags/GitHub/","permalink":"http://catx.me/tags/GitHub/","postCount":6},{"name":"Hexo","slug":"Hexo","path":"tags/Hexo/","permalink":"http://catx.me/tags/Hexo/","postCount":3},{"name":"Node.Js","slug":"Node-Js","path":"tags/Node-Js/","permalink":"http://catx.me/tags/Node-Js/","postCount":3}],"categories":[{"name":"挨踢","slug":"挨踢","path":"categories/挨踢/","permalink":"http://catx.me/categories/挨踢/","postCount":17}]},"next":{"title":"从CoffeeScript源代码中获取文法并可视化","content":"<p>最近在研究把CoffeeScript编译到.Net CLR环境上运行的可能性，在几个CoffeeScript compiler的实现中，没有发现对文法定义的specification，如果要人肉重建不仅工作量忧桑，还有可能导致兼容性问题。于是看了下源代码，发现略施小计就能解决这个问题。</p>\n<p>CoffeeScript的Parser使用jison生成的，所有的文法都在<a href=\"http://coffeescript.org/documentation/docs/grammar.html\" target=\"_blank\" rel=\"external\">grammar.coffee</a>里定义了。这个代码非常好改，去掉对jison的调用，把语法定义用JSON.stringify() format了再输出，执行<a href=\"https://gist.github.com/akfish/8827385\" target=\"_blank\" rel=\"external\">修改后的代码</a>：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">coffee grammar.coffee</span><br></pre></td></tr></table></figure></p>\n<p>就会得到一大串jison格式的文法定义：<br><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"tokens\"</span>:<span class=\"string\">\" TERMINATOR TERMINATOR TERMINATOR STATEMENT INDENT OUTDENT INDENT OUTDENT IDENTIFIER NUMBER STRING JS REGEX BOOL = = INDENT OUTDENT : : INDENT OUTDENT RETURN RETURN HERECOMMENT PARAM_START PARAM_END -&amp;gt; =&amp;gt;  ,  , ... = ... . ?. :: :: INDEX_START INDEX_END INDEX_SOAK &#123; &#125;  , TERMINATOR INDENT OUTDENT CLASS CLASS CLASS EXTENDS CLASS EXTENDS CLASS CLASS CLASS EXTENDS CLASS EXTENDS SUPER SUPER  FUNC_EXIST CALL_START CALL_END CALL_START CALL_END THIS @ @ [ ] [ ] .. ... [ ] , TERMINATOR INDENT OUTDENT INDENT OUTDENT , TRY TRY TRY FINALLY TRY FINALLY CATCH THROW ( ) ( INDENT OUTDENT ) WHILE WHILE WHEN UNTIL UNTIL WHEN LOOP LOOP FOR FOR FOR OWN , FORIN FOROF FORIN WHEN FOROF WHEN FORIN BY FORIN WHEN BY FORIN BY WHEN SWITCH INDENT OUTDENT SWITCH INDENT ELSE OUTDENT SWITCH INDENT OUTDENT SWITCH INDENT ELSE OUTDENT LEADING_WHEN LEADING_WHEN TERMINATOR IF ELSE IF ELSE POST_IF POST_IF UNARY - + -- ++ -- ++ ? + - MATH SHIFT COMPARE LOGIC RELATION COMPOUND_ASSIGN COMPOUND_ASSIGN INDENT OUTDENT EXTENDS\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"bnf\"</span>:</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"string\">\"Root\"</span>:</span><br><span class=\"line\">    [</span><br><span class=\"line\">      [<span class=\"string\">\"\"</span>,<span class=\"string\">\"return $$ = new yy.Block;\"</span>,<span class=\"literal\">null</span>],</span><br><span class=\"line\">      [<span class=\"string\">\"Body\"</span>,<span class=\"string\">\"return $$ = $1;\"</span>,<span class=\"literal\">null</span>],</span><br><span class=\"line\">      [<span class=\"string\">\"Block TERMINATOR\"</span>,<span class=\"string\">\"return $$ = $1;\"</span>,<span class=\"literal\">null</span>]</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Body\"</span>:</span><br><span class=\"line\">    [</span><br><span class=\"line\">      [<span class=\"string\">\"Line\"</span>,<span class=\"string\">\"$$ = yy.Block.wrap([$1]);\"</span>,<span class=\"literal\">null</span>],</span><br><span class=\"line\">      [<span class=\"string\">\"Body TERMINATOR Line\"</span>,<span class=\"string\">\"$$ = $1.push($3);\"</span>,<span class=\"literal\">null</span>],</span><br><span class=\"line\">      [<span class=\"string\">\"Body TERMINATOR\"</span>,<span class=\"string\">\"$$ = $1;\"</span>,<span class=\"literal\">null</span>]</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Line\"</span>:</span><br><span class=\"line\">    [</span><br><span class=\"line\">      [<span class=\"string\">\"Expression\"</span>,<span class=\"string\">\"$$ = $1;\"</span>,<span class=\"literal\">null</span>],</span><br><span class=\"line\">      [<span class=\"string\">\"Statement\"</span>,<span class=\"string\">\"$$ = $1;\"</span>,<span class=\"literal\">null</span>]</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    ...</span><br></pre></td></tr></table></figure></p>\n<p>这样已经算是可用了，但可读性依然不高，经过一番搜索发现一个jison-to-w3c文法标记格式的<a href=\"http://bottlecaps.de/convert/\" target=\"_blank\" rel=\"external\">转换器</a>，得到<a href=\"https://gist.github.com/akfish/8827385\" target=\"_blank\" rel=\"external\">文法</a>：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Root     ::= Body?&#10;Body     ::= Line ( TERMINATOR Line | TERMINATOR )*&#10;Line     ::= Expression&#10;           | Statement&#10;Statement&#10;         ::= Return&#10;           | Comment&#10;           | STATEMENT&#10;Expression&#10;         ::= Value&#10;           | Invocation&#10;           | Code&#10;           | Operation&#10;           | Assign&#10;           | If&#10;           | Try&#10;           | While&#10;           | For&#10;           | Switch&#10;           | Class&#10;           | Throw&#10;...</span><br></pre></td></tr></table></figure></p>\n<p>最后找到一个可视化文法的网站<a href=\"http://bottlecaps.de/rr/ui\" target=\"_blank\" rel=\"external\">Railroad Diagram Generator</a>将其可视化，just for fun:</p>\n<p><a href=\"http://catx.me/wordpress/wp-content/uploads/2014/02/coffee-grammar.png\"><img src=\"/images/064306e5ca2ed757a42cd94fd214d22e49fc19c8.png\" alt=\"coffee-grammar\"></a></p>\n<p>完整的图在：<a href=\"http://project.catx.me/other/coffee-grammar.xhtml\" target=\"_blank\" rel=\"external\">http://project.catx.me/other/coffee-grammar.xhtml</a></p>\n<p>源代码+完整的文法定义：<a href=\"https://gist.github.com/akfish/8827385\" target=\"_blank\" rel=\"external\">https://gist.github.com/akfish/8827385</a></p>\n","date":"2014-02-05T16:55:24.000Z","path":"2014/02/06/get-and-visualize-grammar-definition-of-coffee-script-from-source-code/","isDark":true,"featureColor":"#254277","featureImage":"/image/stock/3.jpg","excerpt":"","featureSwatch":{"Vibrant":{"color":"#254277","isDark":true,"contrast":13.119400726558645},"Muted":{"color":"#526c95","isDark":true,"contrast":5.699027819875463},"DarkVibrant":{"color":"#113a74","isDark":true,"contrast":13.761948622251554},"DarkMuted":{"color":"#425c7b","isDark":true,"contrast":11.860230374565882},"LightVibrant":{"color":"#f4f7fc","isDark":false,"contrast":1.0738073817947642},"LightMuted":{"color":"#8e9db6","isDark":false,"contrast":2.745663409490839}},"permalink":"http://catx.me/2014/02/06/get-and-visualize-grammar-definition-of-coffee-script-from-source-code/","json":"data/posts/2014/02/06/get-and-visualize-grammar-definition-of-coffee-script-from-source-code.json","tags":[{"name":".Net","slug":"Net","path":"tags/Net/","permalink":"http://catx.me/tags/Net/","postCount":4},{"name":"CoffeeScript","slug":"CoffeeScript","path":"tags/CoffeeScript/","permalink":"http://catx.me/tags/CoffeeScript/","postCount":6},{"name":"compiler","slug":"compiler","path":"tags/compiler/","permalink":"http://catx.me/tags/compiler/","postCount":4}],"categories":[{"name":"挨踢","slug":"挨踢","path":"categories/挨踢/","permalink":"http://catx.me/categories/挨踢/","postCount":17}]}}