{"tag":"HID","isDark":false,"type":"tag","path":"tags/HID/","json_base":"data/tags/HID/","json":"data/tags/HID/1.json","current":1,"total":1,"posts":[{"type":"post","json_base":"data/posts","json":"data/posts/2014/03/11/build-and-use-virtual-hid-driver.json","path":"2014/03/11/build-and-use-virtual-hid-driver/","data":{"title":"编译并使用虚拟HID驱动","content":"<h2 id=\"u80CC_u666F\"><a href=\"#u80CC_u666F\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>虚拟HID驱动用于虚拟一个或多个人机交互设备，如键盘、鼠标、摇杆等，作用都懂的。<br>经过搜索发现一个开源项目<a href=\"https://code.google.com/p/vmulti/\" target=\"_blank\" rel=\"external\">vmulti</a>，实现了虚拟的多点触控、鼠标、键盘、摇杆以及数位笔，省去了自己写驱动的麻烦。</p>\n<h2 id=\"u7F16_u8BD1vmulti\"><a href=\"#u7F16_u8BD1vmulti\" class=\"headerlink\" title=\"编译vmulti\"></a>编译vmulti</h2><ol>\n<li>安装WDK</li>\n<li>运行以管理员权限WDK build environment</li>\n<li>进入vmulti工程文件夹，运行</li>\n</ol>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">build -wgc</span><br></pre></td></tr></table></figure>\n<ol>\n<li>把编译生成的<code>vmulti.sys</code>、<code>multi.inf</code>、<code>hidkmdf.sys</code>文件放到同一个文件夹</li>\n<li>把WDK中的<code>WdfCoInstaller01009.dll</code>, <code>devcon.exe</code>也放到这个文件夹</li>\n</ol>\n<h2 id=\"u9A71_u52A8_u7B7E_u540D\"><a href=\"#u9A71_u52A8_u7B7E_u540D\" class=\"headerlink\" title=\"驱动签名\"></a>驱动签名</h2><p>Windows x64系统上无法安装无签名的驱动，需要进行self sign。所有操作需要在管理员权限的WDK build environment中执行。</p>\n<h3 id=\"u6253_u5F00Windows_u6D4B_u8BD5_u6A21_u5F0F\"><a href=\"#u6253_u5F00Windows_u6D4B_u8BD5_u6A21_u5F0F\" class=\"headerlink\" title=\"打开Windows测试模式\"></a>打开Windows测试模式</h3><p>要加载self sign的内核代码，需要打开windows的测试模式：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bcdedit /set testsigning on</span><br></pre></td></tr></table></figure>\n<p>重启。</p>\n<h3 id=\"u521B_u5EFA_u8BC1_u4E66\"><a href=\"#u521B_u5EFA_u8BC1_u4E66\" class=\"headerlink\" title=\"创建证书\"></a>创建证书</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">makecert -r -pe -ss &#34;CatX&#34; -n &#34;CN=CatX Test Certificate&#34; catx.cer&#10;certmgr -add catx.cer /s /r localMachine root&#10;certmgr -add catx.cer /s /r localMachine trustedpublisher</span><br></pre></td></tr></table></figure>\n<p>验证证书是否正确安装，运行：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certmgr</span><br></pre></td></tr></table></figure>\n<h3 id=\"u7B7E_u540D\"><a href=\"#u7B7E_u540D\" class=\"headerlink\" title=\"签名\"></a>签名</h3><p>驱动中的如下文件需要签名：</p>\n<ul>\n<li><code>*.sys</code>文件</li>\n<li><code>*.inf</code>中引用的<code>*.cat</code>文件</li>\n</ul>\n<p>如果<code>*.cat</code>文件不存在，需要运行inf2cat创建：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">inf2cat /driver:%driver_folder% /os:7_x64</span><br></pre></td></tr></table></figure>\n<p>vmulti需要签名的文件有vmulti.sys、hidkmdf.sys和kmdfsamples.cat，运行：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">signtool sign /v /s &#34;CatX&#34; /n &#34;CatX Test Certificate&#34; /t http://timestamp.verisign.com/scripts/timestamp.dll %file_name%</span><br></pre></td></tr></table></figure>\n<p>验证签名：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">signtool verify /pa /v *.cat *.sys</span><br></pre></td></tr></table></figure>\n<h2 id=\"u5B89_u88C5vmulti\"><a href=\"#u5B89_u88C5vmulti\" class=\"headerlink\" title=\"安装vmulti\"></a>安装vmulti</h2><p>运行：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">devcon install vmulti.inf djpnewton\\vmulti</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"u6D4B_u8BD5\"><a href=\"#u6D4B_u8BD5\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>vmulti工程中包含了一个测试程序<code>testvmulti.exe</code>，用于测试驱动功能：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">testvmulti.exe /multitouch&#10;testvmulti.exe /mouse&#10;testvmulti.exe /digitizer</span><br></pre></td></tr></table></figure></p>\n","date":"2014-03-11T02:24:16.000Z","path":"2014/03/11/build-and-use-virtual-hid-driver/","isDark":true,"featureColor":"#2f5a75","featureImage":"/image/stock/2.jpg","excerpt":"","featureSwatch":{"Vibrant":{"color":"#2f5a75","isDark":true,"contrast":12.293085300100254},"Muted":{"color":"#64767c","isDark":true,"contrast":5.234975288978602},"DarkVibrant":{"color":"#1f4b68","isDark":true,"contrast":13.414009026295917},"DarkMuted":{"color":"#477084","isDark":true,"contrast":5.611238656641319},"LightVibrant":{"color":"#ecdabf","isDark":false,"contrast":1.3683052639522741},"LightMuted":{"color":"#95b1b5","isDark":false,"contrast":2.274202152883682}},"json":"data/posts/2014/03/11/build-and-use-virtual-hid-driver.json","tags":[{"name":"HID","slug":"HID","path":"tags/HID/","permalink":"http://catx.me/tags/HID/","postCount":1},{"name":"驱动","slug":"驱动","path":"tags/驱动/","permalink":"http://catx.me/tags/驱动/","postCount":1}],"categories":[{"name":"挨踢","slug":"挨踢","path":"categories/挨踢/","permalink":"http://catx.me/categories/挨踢/","postCount":24}]},"sha1":"5e5a3640ccb5c4e126aed7f7acf5c4771bce3fca","isDigest":true}],"sha1":"635c5690342ec290d045ecbd7730b11014a9323b"}